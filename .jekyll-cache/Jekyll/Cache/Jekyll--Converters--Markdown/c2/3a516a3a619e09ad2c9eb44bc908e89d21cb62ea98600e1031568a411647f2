I"üj<p>C++11 æ ‡å‡†å¼•å…¥äº†å¯¹çº¿ç¨‹çš„æ”¯æŒï¼Œè¿™äº›æ”¯æŒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>

<p><strong>std::thread</strong> ç±»ï¼šC++11ä¸­å¼•å…¥äº† <code class="language-plaintext highlighter-rouge">std::thread</code> ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå¯æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ã€‚</p>

<p><strong>std::mutex</strong> ç±»ï¼š<code class="language-plaintext highlighter-rouge">std::mutex </code>ç±»æä¾›äº†ä¸€ç§åŸºæœ¬çš„äº’æ–¥æœºåˆ¶ï¼Œå…è®¸ç¨‹åºå‘˜é€šè¿‡å¯¹å…±äº«èµ„æºçš„è®¿é—®è¿›è¡ŒåŒæ­¥ã€‚</p>

<p><strong>std::condition_variable</strong> ç±»ï¼š<code class="language-plaintext highlighter-rouge">std::condition_variable</code> ç±»æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—çº¿ç¨‹èƒ½å¤Ÿç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹è½®è¯¢ç­‰å¾…çš„é—®é¢˜ã€‚</p>

<p><strong>std::future</strong> å’Œ <code class="language-plaintext highlighter-rouge">std::promise</code> ç±»ï¼š<code class="language-plaintext highlighter-rouge">std::future</code> å’Œ <code class="language-plaintext highlighter-rouge">std::promise</code> ç±»æä¾›äº†ä¸€ç§å¼‚æ­¥ç¼–ç¨‹çš„æ–¹å¼ï¼Œå…è®¸ç¨‹åºå‘˜å°†ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å¾—åˆ°è¿”å›å€¼ã€‚</p>

<p><strong>std::atomic</strong> ç±»ï¼š<code class="language-plaintext highlighter-rouge">std::atomic </code>ç±»æä¾›äº†ä¸€ç§åŸºæœ¬çš„åŸå­æ“ä½œï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¿è¯å…±äº«å˜é‡çš„åŸå­æ€§æ“ä½œã€‚</p>

<p><strong>Thread-local storage</strong>ï¼šC++11 æ ‡å‡†ä¸­å¼•å…¥äº† <code class="language-plaintext highlighter-rouge">thread_local</code> å…³é”®å­—ï¼Œç”¨äºæŒ‡å®šå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­æ˜¯å”¯ä¸€çš„ã€‚</p>

<h1 id="stdthread">std::thread</h1>

<p>åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹è¾“å‡ºå¥‡æ•°ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¾“å‡ºå¶æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">printOddNumbers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Odd number: "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">printEvenNumbers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Even number: "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">printOddNumbers</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">printEvenNumbers</span><span class="p">);</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>åœ¨ä¸»å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ª<code class="language-plaintext highlighter-rouge"> std::thread </code>å¯¹è±¡ t1 å’Œ t2ï¼Œå¹¶å°† <code class="language-plaintext highlighter-rouge">printOddNumbers()</code> å’Œ <code class="language-plaintext highlighter-rouge">printEvenNumbers()</code> ä½œä¸ºçº¿ç¨‹å‡½æ•°ä¼ é€’ç»™å®ƒä»¬ã€‚ç„¶åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">join()</code> å‡½æ•°ç­‰å¾…çº¿ç¨‹çš„ç»“æŸã€‚è¿è¡Œç¨‹åºåï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Odd number: 1
Odd number: 3
Odd number: 5
Odd number: 7
Odd number: 9
Even number: 2
Even number: 4
Even number: 6
Even number: 8
Even number: 10
</code></pre></div></div>

<h1 id="stdthread-1">std::thread</h1>

<p>å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ counterï¼Œå¹¶ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹å…¶è¿›è¡ŒåŠ å’Œå‡çš„æ“ä½œï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">printOddNumbers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Odd number: "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">printEvenNumbers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Even number: "</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">printOddNumbers</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">printEvenNumbers</span><span class="p">);</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">std::mutex</code> çš„ä½œç”¨æ˜¯å¯¹å…¨å±€å˜é‡ <code class="language-plaintext highlighter-rouge">counter</code> è¿›è¡Œäº’æ–¥è®¿é—®ï¼Œé¿å…äº†ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹å¯¼è‡´çš„æ•°æ®ç«äº‰é—®é¢˜ã€‚å…¶ä¸­ï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">add</code> å’Œ <code class="language-plaintext highlighter-rouge">sub</code> å‡½æ•°ä¸­ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::mutex</code> çš„ <code class="language-plaintext highlighter-rouge">lock()</code> å’Œ <code class="language-plaintext highlighter-rouge">unlock()</code> æ–¹æ³•æ¥å¯¹äº’æ–¥é‡è¿›è¡ŒåŠ é”å’Œè§£é”ï¼Œä»è€Œç¡®ä¿äº†ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®è®¿é—®äº’æ–¥æ€§ã€‚</p>

<h1 id="stdcondition_variable">std::condition_variable</h1>

<p>ç”¨äºçº¿ç¨‹é—´çš„æ¡ä»¶å˜é‡ç­‰å¾…å’Œé€šçŸ¥ã€‚å®ƒæ˜¯é…åˆ <code class="language-plaintext highlighter-rouge">std::unique_lock</code> ä½¿ç”¨çš„ï¼Œç”¨äºçº¿ç¨‹é—´å…±äº«æ•°æ®çš„åŒæ­¥ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºï¼Œä½¿ç”¨ std::condition_variable å®ç°ä¸¤ä¸ªçº¿ç¨‹é—´çš„åŒæ­¥ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cv</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">consumer</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span> <span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Consumer: data = "</span> <span class="o">&lt;&lt;</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">producer</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">data</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">consumer_thread</span><span class="p">(</span><span class="n">consumer</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">producer_thread</span><span class="p">(</span><span class="n">producer</span><span class="p">);</span>

    <span class="n">consumer_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">producer_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">consumer()</code> å’Œ <code class="language-plaintext highlighter-rouge">producer()</code> åˆ†åˆ«è¿è¡Œåœ¨ä¸¤ä¸ªçº¿ç¨‹ä¸­ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">consumer()</code> ä¸­ä½¿ç”¨ s<code class="language-plaintext highlighter-rouge">td::unique_lock</code> å¯¹ mtx è¿›è¡ŒåŠ é”ï¼Œå¹¶åœ¨ while å¾ªç¯ä¸­ç­‰å¾…æ¡ä»¶å˜é‡ ready çš„å€¼ä¸º trueï¼Œä»¥é˜²æ­¢åœ¨æ•°æ®æœªå‡†å¤‡å¥½æ—¶è®¿é—® dataã€‚</p>

<p><code class="language-plaintext highlighter-rouge">producer()</code> ä¸­é¦–å…ˆç­‰å¾… 1 ç§’é’Ÿä»¥æ¨¡æ‹Ÿæ•°æ®çš„å‡†å¤‡è¿‡ç¨‹ï¼Œç„¶åä¿®æ”¹ data çš„å€¼ä¸º 42ï¼Œå¹¶å°† ready çš„å€¼è®¾ç½®ä¸º trueï¼Œæœ€åé€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">cv.notify_one()</code> é€šçŸ¥ç­‰å¾…ä¸­çš„çº¿ç¨‹å¯ä»¥å¼€å§‹è®¿é—®æ•°æ®äº†ã€‚</p>

<p>æœ€ååœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ <code class="language-plaintext highlighter-rouge">join()</code> ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹ç»“æŸã€‚</p>

<h1 id="stdfuture">std::future</h1>

<p><code class="language-plaintext highlighter-rouge">std::future</code> å’Œ <code class="language-plaintext highlighter-rouge">std::promise</code> æ˜¯ C++11 ä¸­æä¾›çš„ç”¨äºçº¿ç¨‹é—´é€šä¿¡çš„å·¥å…·ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">std::promise</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå¯ä»¥åœ¨æŸä¸ªçº¿ç¨‹ä¸­è®¾ç½®ä¸€ä¸ªå€¼ï¼Œå¹¶è®©å¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…è¯¥å€¼çš„äº§ç”Ÿï¼Œè€Œ <code class="language-plaintext highlighter-rouge">std::future</code> åˆ™æ˜¯ç”¨æ¥è·å–è¿™ä¸ªå€¼çš„ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œç”¨äºæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::future</code> å’Œ <code class="language-plaintext highlighter-rouge">std::promise</code>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;future&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">printValue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">fut</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fut</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Value: "</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">prom</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">fut</span> <span class="o">=</span> <span class="n">prom</span><span class="p">.</span><span class="n">get_future</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">th1</span><span class="p">(</span><span class="n">printValue</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">fut</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">th2</span><span class="p">([](</span><span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">prom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
        <span class="n">prom</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">prom</span><span class="p">));</span>

    <span class="n">th1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">th2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åˆ›å»ºäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">std::promise</code> å¯¹è±¡ <code class="language-plaintext highlighter-rouge">prom</code>ï¼Œå¹¶é€šè¿‡å®ƒè·å–äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">std::future</code> å¯¹è±¡ <code class="language-plaintext highlighter-rouge">fut</code>ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ th1 å’Œ th2ï¼Œå…¶ä¸­ th1 ç­‰å¾… fut çš„å€¼çš„äº§ç”Ÿï¼Œå¹¶åœ¨äº§ç”Ÿåå°†å…¶æ‰“å°å‡ºæ¥ï¼›è€Œ th2 åˆ™ä¼šç­‰å¾… 2 ç§’é’Ÿåï¼Œå°†å€¼ 10 è®¾ç½®åˆ° prom ä¸­ï¼Œä½¿å¾— th1 å¯ä»¥è·å–è¿™ä¸ªå€¼å¹¶æ‰“å°å‡ºæ¥ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å°† <code class="language-plaintext highlighter-rouge">std::promise</code> å¯¹è±¡ prom ä¼ é€’ç»™çº¿ç¨‹ th2 çš„ <code class="language-plaintext highlighter-rouge">lambda</code> è¡¨è¾¾å¼æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::ref()</code> å‡½æ•°å°†å…¶åŒ…è£…æˆä¸€ä¸ªå¼•ç”¨ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°†æ— æ³•æ­£ç¡®åœ°å¤„ç†å®ƒã€‚</p>

<h1 id="stdatomic">std::atomic</h1>

<p><code class="language-plaintext highlighter-rouge">std::atomic</code> æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ªç”¨äºåŸå­æ“ä½œçš„åº“ï¼Œå¯ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ç«äº‰ã€‚</p>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ std::atomic çš„ç®€å•ç¤ºä¾‹ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¯¹å…±äº«å˜é‡è¿›è¡ŒåŠ ä¸€æ“ä½œï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span>
<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">counter</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// å®šä¹‰åŸå­å˜é‡</span>

<span class="kt">void</span> <span class="nf">increment_counter</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">counter</span><span class="p">;</span> <span class="c1">// å¯¹åŸå­å˜é‡è¿›è¡ŒåŠ ä¸€æ“ä½œ</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">increment_counter</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">increment_counter</span><span class="p">);</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Counter value: "</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// è¾“å‡ºå…±äº«å˜é‡çš„å€¼</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å®šä¹‰äº†ä¸€ä¸ªåä¸º <code class="language-plaintext highlighter-rouge">counter</code> çš„åŸå­å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">increment_counter()</code> å‡½æ•°ï¼Œå¯¹ <code class="language-plaintext highlighter-rouge">counter</code> è¿›è¡Œ 10000 æ¬¡åŠ ä¸€æ“ä½œã€‚ç”±äºä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge"> std::atomic</code>ï¼Œè¿™ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚æœ€ç»ˆè¾“å‡º <code class="language-plaintext highlighter-rouge">counter</code> çš„å€¼ã€‚</p>

<h1 id="thread-local-storage">Thread-local storage</h1>

<p><strong>Thread-local storageï¼ˆTLSï¼‰</strong>æ˜¯æŒ‡æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™äº›å­˜å‚¨ç©ºé—´å¯ä»¥ç”¨æ¥å­˜å‚¨çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº’ä¸å¹²æ‰°ã€‚TLS æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ›´åŠ é«˜æ•ˆåœ°ä½¿ç”¨å…¨å±€å˜é‡ã€‚</p>

<p>C++11ä¸­å¼•å…¥äº† <code class="language-plaintext highlighter-rouge">thread_local</code> å…³é”®å­—ï¼Œå®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°å…¨å±€å˜é‡ã€é™æ€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ã€‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">thread_local</code> ä¿®é¥°çš„å˜é‡åªæœ‰åœ¨å£°æ˜å®ƒçš„çº¿ç¨‹ä¸­å¯è§ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°è¯¥å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ã€‚</p>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ <code class="language-plaintext highlighter-rouge">thread_local</code> ä¿®é¥°çš„å…¨å±€å˜é‡çš„ä¾‹å­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span>
<span class="k">thread_local</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">x</span><span class="o">++</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Thread "</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>ä»¬å®šä¹‰äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">thread_local</code> çš„å…¨å±€å˜é‡xï¼Œå¹¶åœ¨ foo å‡½æ•°ä¸­å¯¹å…¶è¿›è¡Œä¿®æ”¹å’Œæ‰“å°ã€‚æ¥ç€åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ t1 å’Œ t2ï¼Œå¹¶åˆ†åˆ«æ‰§è¡Œ foo å‡½æ•°ï¼Œæœ€åè°ƒç”¨ join å‡½æ•°ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚</p>

<p>ç”±äº x æ˜¯ <code class="language-plaintext highlighter-rouge">thread_local</code> å˜é‡ï¼Œå› æ­¤åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹ x çš„ä¿®æ”¹äº’ä¸å¹²æ‰°ã€‚è¿è¡Œç»“æœå¯èƒ½ç±»ä¼¼äºï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 139861759004416: 1
Thread 139861750611712: 1

</code></pre></div></div>

<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„xå˜é‡å‰¯æœ¬ï¼Œå¹¶ä¸”åªèƒ½è®¿é—®åˆ°è‡ªå·±çš„å‰¯æœ¬ã€‚è¿™æ ·å¯ä»¥é¿å…ä¸åŒçº¿ç¨‹ä¹‹é—´å¯¹åŒä¸€å…¨å±€å˜é‡çš„ç«äº‰å’Œå†²çªï¼Œä»è€Œæé«˜ç¨‹åºçš„ç¨³å®šæ€§å’Œå¹¶å‘æ€§èƒ½ã€‚</p>
:ET