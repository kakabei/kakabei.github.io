I"Ü,<p>muduo å¯¹äºæ—¶é—´çš„æ‘†é€‰æ‹©å¯çœ‹  <a href="http://blog.xyecho.com/muduo-7-muduo-timer/">muduoç¬”è®° ç¬¬ä¸ƒç«  å®šæ—¶å™¨</a></p>

<p>muduo çš„ å®šæ—¶å™¨åŠŸèƒ½ç”± ä¸‰ä¸ªclasså®ç°ï¼Œ<code class="language-plaintext highlighter-rouge">TimerIdã€Timerã€TimerQueue</code>ï¼Œ ç”¨æˆ·åªèƒ½çœ‹åˆ°ç¬¬ä¸€ä¸ªclassï¼Œ å¦å¤–ä¸¤ä¸ªéƒ½æ˜¯å†…éƒ¨å®ç°ç»†èŠ‚ã€‚</p>

<p>Timerä¸­ æœ‰ç”¨åˆ° Timestamp class  è¿™ä¸ªä¸€ä¸ªå°è£…äº†å¾®ç§’çš„æ—¶é—´æˆ³ç±»ã€‚</p>

<p><strong>å…¶ä¸­now() è°ƒç”¨çš„æ˜¯ gettimeofday() è¿™ä¸ªå‡½æ•°ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯åœ¨ç”¨æˆ·æ€å®ç°çš„ã€‚ æ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œé™·å…¥å†…æ ¸çš„å¼€é”€ã€‚</strong></p>

<p>è¢«çœŸæ­£ç”¨å‡½æ•°æ˜¯EventLoop çš„ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">TimerId</span> <span class="nf">runAt</span><span class="p">(</span><span class="k">const</span> <span class="n">Timestamp</span><span class="o">&amp;</span> <span class="n">time</span><span class="p">,</span> <span class="n">TimerCallback</span><span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="p">);</span>
 <span class="n">TimerId</span> <span class="nf">runAfter</span><span class="p">(</span><span class="kt">double</span> <span class="n">delay</span><span class="p">,</span> <span class="n">TimerCallback</span><span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="p">);</span>
 <span class="n">TimerId</span> <span class="nf">runEvery</span><span class="p">(</span><span class="kt">double</span> <span class="n">interval</span><span class="p">,</span> <span class="n">TimerCallback</span><span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="p">);</span>
 <span class="kt">void</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">TimerId</span> <span class="n">timerId</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™ä¸€äº›å‡½æ•°éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<h3 id="å®šæ—¶å™¨timer">å®šæ—¶å™¨Timer</h3>

<p>Timer æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ç±»ã€‚
ä¸»è¦æˆå‘˜æœ‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">TimerCallback</span> <span class="n">callback_</span><span class="p">;</span>   <span class="c1">// æ—¶é—´å›è°ƒå‡½æ•°</span>
<span class="n">Timestamp</span> <span class="n">expiration_</span><span class="p">;</span>           <span class="c1">// æ—¶é—´  ï¼ˆå¾®ç§’ï¼‰</span>
<span class="k">const</span> <span class="kt">double</span> <span class="n">interval_</span><span class="p">;</span>          <span class="c1">// å­—é¢çš„ç†è§£ æ—¶é—´é—´éš”</span>
<span class="k">const</span> <span class="kt">bool</span> <span class="n">repeat_</span><span class="p">;</span>              <span class="c1">//  å¦‚æœtrue å°±æ˜¯æŠŠinterval_åŠ åˆ°expiration_ </span>
<span class="k">const</span> <span class="kt">int64_t</span> <span class="n">sequence_</span><span class="p">;</span>         <span class="c1">//  å®šæ—¶å™¨åºå· è¿™æ˜¯ä»€ä¹ˆåœºæ™¯ç”¨çš„ï¼Ÿ</span>

</code></pre></div></div>
<p>å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°æ˜¯åœ¨è¢«è®¾ç½®åœ¨Timerä¸­çš„ã€‚</p>

<h3 id="æ—¶é—´ç®¡ç†é˜Ÿåˆ—-timerqueue">æ—¶é—´ç®¡ç†é˜Ÿåˆ— TimerQueue</h3>

<p>åº”è¯¥å¯ä»¥çœ‹ç€æ˜¯å¯¹Timerçš„ç®¡ç†ç±»å§ã€‚æœ€æ ¸å¿ƒçš„åœ°æ–¹åº”è¯¥å°±æ˜¯å¯¹æ—¶é—´çš„ç®¡ç† ï¼Œä¸»è¦æ˜¯æ’åºï¼Œå°±æ˜¯æ€ä¹ˆèƒ½å¿«é€Ÿæ‰“åˆ°å·²ç»åˆ°æœŸçš„Timerã€‚ä¹Ÿèƒ½é«˜æ•ˆçš„å¢åŠ å’Œåˆ é™¤Timer.</p>

<p>TimerQueue æ’è¡Œæ˜¯ç”¨stl setã€‚ 
keyå€¼æ˜¯ä¸€ä¸ªpair &lt;Timestamp, Timer*&gt; ã€‚ è¿™æ ·è§£å†³äº†å¦‚æœæ—¶é—´ç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œç¬¬äºŒä¸ªåœ°å€ä¹Ÿä¸å¯èƒ½ç›¸ç­‰ã€‚</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">Timer</span><span class="o">*&gt;</span> <span class="n">Entry</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">TimerList</span><span class="p">;</span>
<span class="n">TimerList</span> <span class="n">timers_</span><span class="p">;</span>  <span class="c1">// Timer list sorted by expiration æŒ‰è¶…æ—¶çš„æ—¶é—´é¡ºåº</span>
</code></pre></div></div>

<p>TimerQueue çš„ä¸»è¦æ–¹æ³• æ˜¯ :</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TimerId</span> <span class="nf">addTimer</span><span class="p">(</span><span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span>
                   <span class="n">Timestamp</span> <span class="n">when</span><span class="p">,</span>
                   <span class="kt">double</span> <span class="n">interval</span><span class="p">);</span>

</code></pre></div></div>

<p>è¿™ä»£ç ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹åº”è¯¥è¦æ³¨æ„åˆ°çš„æ˜¯ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è¿™ä¸ªå‡½æ•°ç›´æ¥çš„è¿”å›äº†å±€éƒ¨çš„ vector è¿™ä¸ªåšæ²¡æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ</span>
<span class="c1">// </span>
<span class="c1">// rvo realeaseç‰ˆæœ¬ä¼˜åŒ– æ‰€ä»¥ä¸éœ€è¦è¿”å›å¼•ç”¨æˆ–æŒ‡é’ˆ</span>
<span class="c1">// RVO:å³releaseç‰ˆæœ¬ä¸­ä¼šå¯¹ä»£ç ä¼˜åŒ– ä½¿å¾—è¿”å›ä¸€ä¸ªå¯¹è±¡ä¸è®¸è°ƒç”¨æ‹·è´æ„é€ å‡½æ•° æ‰€ä»¥å¯ä»¥è¿”å›ä¸€ä¸ªå¯¹è±¡ ä¸ç”¨æŒ‡é’ˆæˆ–è€…å¼•ç”¨</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TimerQueue</span><span class="o">::</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">TimerQueue</span><span class="o">::</span><span class="n">getExpired</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">expired</span><span class="p">;</span>
  <span class="n">Entry</span> <span class="n">sentry</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">UINTPTR_MAX</span><span class="p">));</span>
  <span class="n">TimerList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">end</span> <span class="o">=</span> <span class="n">timers_</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">sentry</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">timers_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">||</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>    <span class="c1">// åœ¨è¿™é‡Œåšæ¯”è¾ƒï¼Œ æ¯”nowå¤§çš„æ‰€æœ‰Entry</span>
  <span class="c1">// è¿™é‡Œæ˜¯ä»ä¸€ä¸ªsetæ‹·è´åˆ°vector</span>
  <span class="c1">// æœ€æ–°ç‰ˆæœ¬æ”¹ä¸ºå¦‚ä¸‹ï¼š</span>
  <span class="c1">// expired.assign(timers_.begin(), end);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">,</span> <span class="n">back_inserter</span><span class="p">(</span><span class="n">expired</span><span class="p">));</span>
  <span class="n">timers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">end</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">expired</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="n">it</span> <span class="o">!=</span> <span class="n">expired</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ActiveTimer</span> <span class="n">timer</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">());</span>
    <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">activeTimers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span> <span class="c1">// è¿™é‡Œä¹Ÿå‡ºç°äº† å¯¹ä¸€ä¸ª æ•´å‹ è¿›è¡Œ(void)?  é˜²å˜é‡æœªè®¾ç½®é”™è¯¯</span>
  <span class="p">}</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">expired</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å–å‡ºè¿‡æœŸçš„Timeråˆ—è¡¨ã€‚ å¯ä»¥å®ƒçš„è¿”å›äº†ä¸€ä¸ªå‡½æ•°å†…çš„å±€éƒ¨vectorã€‚ä»¥åæ˜¯æœ‰é—®é¢˜ï¼Œä½†åˆè§‰å¾—ï¼Œä¸€ä¸ªè¿˜ç®—æ¯”è¾ƒæµè¡Œçš„æºå¼€æ”¾é¡¹ç›®ï¼Œä¸å¤ªå¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚æŸ¥äº†ä¸€ä¸‹ï¼Œæ‰çŸ¥é“ï¼Œè¿˜æ˜¯è‡ªå·±çš„çŸ¥è¯†æœ‰é™å•Šã€‚ è¿™ç§æ–¹å¼å«vo realeaseç‰ˆæœ¬ä¼˜åŒ–ã€‚<a href="http://blog.xyecho.com/muduo-8-muduo-rvo-realease/">rvo realeaseç‰ˆæœ¬ä¼˜åŒ–</a></p>

<p>å…³äºå¯¹ TimerList timers_çš„ä¸€äº›æ“ä½œä¹Ÿå˜è›®ä¸å¥½ç†è§£çš„ã€‚</p>

<p>æ˜¯ TimerQueue å› è°ƒç”¨æˆ·ä»£ç onTimer() çš„æ—¶åºå›¾ã€‚</p>

<p><img src="/assets/muduo/8-timer-queue.png" alt="" /></p>

<hr />
<p>-â€“ ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ï¼šä½¿ç”¨muduo C++ ç½‘ç»œåº“ã€‹ é™ˆç¡•. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾. Kindle ç‰ˆæœ¬.</p>

:ET