I"¨[<p>c++ 11  æ–°å¢ä¸‰ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œ <code class="language-plaintext highlighter-rouge">unique_ptr</code>ã€<code class="language-plaintext highlighter-rouge">shared_ptr</code> ä»¥åŠ <code class="language-plaintext highlighter-rouge">weak_ptr</code> æ¥å®ç°<strong>å †å†…å­˜çš„è‡ªåŠ¨å›æ”¶</strong>ã€‚</p>

<p>æ™ºèƒ½æŒ‡é’ˆå¯ä»¥åœ¨é€‚å½“æ—¶æœºè‡ªåŠ¨é‡Šæ”¾åˆ†é…çš„å†…å­˜ï¼Œå¯ä»¥å¾ˆå¥½åœ°é¿å…â€œå¿˜è®°é‡Šæ”¾å†…å­˜è€Œå¯¼è‡´å†…å­˜æ³„æ¼â€é—®é¢˜å‡ºç°ã€‚</p>

<p>åŸç†ï¼š</p>

<p>æ™ºèƒ½æŒ‡é’ˆåº•å±‚æ˜¯é€šè¿‡<strong>å¼•ç”¨è®¡æ•°</strong>çš„æ–¹å¼å®ç°çš„ã€‚æ™ºèƒ½æŒ‡é’ˆåœ¨ç”³è¯·å †å†…å­˜ç©ºé—´çš„åŒæ—¶ï¼Œä¼šä¸ºå…¶é…å¤‡ä¸€ä¸ªæ•´å½¢å€¼ï¼ˆåˆå§‹å€¼ä¸º 1ï¼‰ï¼Œæ¯å½“æœ‰æ–°å¯¹è±¡ä½¿ç”¨æ­¤å †å†…å­˜æ—¶ï¼Œè¯¥æ•´å½¢å€¼ +1ï¼›åä¹‹ï¼Œæ¯å½“ä½¿ç”¨æ­¤å †å†…å­˜çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œè¯¥æ•´å½¢å€¼å‡ 1ã€‚å½“å †ç©ºé—´å¯¹åº”çš„æ•´å½¢å€¼ä¸º 0 æ—¶ï¼Œå³è¡¨æ˜ä¸å†æœ‰å¯¹è±¡ä½¿ç”¨å®ƒï¼Œè¯¥å †ç©ºé—´å°±ä¼šè¢«é‡Šæ”¾æ‰ã€‚</p>

<p>ä½¿ç”¨æ—¶éœ€æ·»åŠ å¤´æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">&lt;memory&gt;</code>ã€‚</p>

<h1 id="shared_ptr-ç”¨æ³•">shared_ptr ç”¨æ³•</h1>

<p><code class="language-plaintext highlighter-rouge">shared_ptr</code> æ˜¯ä¸€ä¸ªæ¨¡æ¿ã€‚åˆ›å»ºæ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œå¿…é¡»æä¾›æŒ‡é’ˆæ‰€æŒ‡çš„ç±»å‹ã€‚å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ã€<code class="language-plaintext highlighter-rouge">std::make_shared&lt;T&gt;</code>è¾…åŠ©å‡½æ•° å’Œ<code class="language-plaintext highlighter-rouge">reset</code>æ–¹æ³•æ¥åˆå§‹åŒ– <code class="language-plaintext highlighter-rouge">shared_ptr</code>ã€‚</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p1</span><span class="p">;</span> <span class="c1">//æŒ‡å‘ string</span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">string</span> <span class="o">&gt;&gt;</span> <span class="n">p2</span><span class="p">;</span><span class="c1">//æŒ‡å‘ string çš„ list</span>
<span class="k">if</span><span class="p">(</span><span class="n">p1</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span>
	<span class="o">*</span><span class="n">p1</span><span class="o">=</span><span class="s">"h1"</span><span class="p">;</span>
</code></pre></div></div>

<p>ç”¨ <code class="language-plaintext highlighter-rouge">make_shared</code> çš„æ–¹å¼ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æŒ‡å‘ string çš„ shared_ptr </span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"name"</span><span class="p">);</span> 

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">);</span> 

<span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</code></pre></div></div>

<h1 id="shared_ptr-æ‹·è´èµ‹å€¼ä¸å¼•ç”¨è®¡æ•°">shared_ptr æ‹·è´ã€èµ‹å€¼ä¸å¼•ç”¨è®¡æ•°</h1>

<p>1ã€<code class="language-plaintext highlighter-rouge">shared_ptr</code> ç”¨çš„æ˜¯<strong>å¼•ç”¨è®¡æ•°</strong>çš„æ–¹å¼ã€‚æ‰€ä»¥æ‰€æŒ‡å‘çš„ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚</p>

<p>2ã€å¯¹ <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç±»è¿›è¡Œæ‹·è´æ—¶ï¼Œè®¡æ•°å™¨å°±ä¼šå¢åŠ ã€‚å¦‚ï¼š1ï¼‰ç”¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> åˆå§‹åŒ–å¦ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code>ã€2) ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æˆ–å‡½æ•°çš„è¿”å›å€¼ï¼Œå®ƒæ‰€å…³è”çš„è®¡æ•°å™¨å°±ä¼šå¢åŠ ã€‚</p>

<p>3ã€å½“ç»™è®© <code class="language-plaintext highlighter-rouge">shared_ptr</code> æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡æˆ–è€… <code class="language-plaintext highlighter-rouge">shared_ptr</code> é”€æ¯æ—¶ï¼ŒåŸå¯¹è±¡çš„è®¡æ•°å™¨å°±ä¼šé€’å‡ã€‚</p>

<p>4ã€<code class="language-plaintext highlighter-rouge">shared_ptr</code> çš„è®¡æ•°å™¨ä¸º 0ï¼Œå°±ä¼šè‡ªåŠ¨é‡Šæ”¾è¯¥å¯¹è±¡çš„å†…å­˜ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">);</span> <span class="c1">// ptr æŒ‡å‘ä¸€ä¸ªå¼•ç”¨è€… </span>

<span class="k">auto</span> <span class="nf">ptr2</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>                   <span class="c1">//ç”¨ ptr åˆå§‹åŒ– ptr2ï¼Œé‚£ä¹ˆ ptr æ‰€æŒ‡çš„å¯¹è±¡è®¡æ•°å™¨åŠ 1</span>

<span class="k">auto</span> <span class="n">ptr3</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"name"</span><span class="p">);</span>

<span class="n">ptr3</span>  <span class="o">=</span> <span class="n">ptr2</span><span class="p">;</span> <span class="c1">// ptr3 åŸæ¥æ‰€æŒ‡çš„å¯¹è±¡å¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œç„¶åè‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚ptr2 æ‰€æŒ‡çš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1</span>
</code></pre></div></div>

<p>å½“æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æœ€åä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">shared_ptr</code>ç±»ä¼šè‡ªåŠ¨é”€æ¯æ­¤å¯¹è±¡ã€‚<code class="language-plaintext highlighter-rouge">shared_ptr</code> ç±»æ˜¯é€šè¿‡ææ„å‡½æ•°æ¥å®Œæˆé”€æ¯å·¥ä½œã€‚
åªè¦æœ‰å­˜åœ¨ä¸€ä¸ª  <code class="language-plaintext highlighter-rouge">shared_ptr</code> ï¼ŒæŒ‡å‘çš„å†…å­˜å°±ä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>

<h1 id="shared_ptr-ä½œç”¨åŸŸ">shared_ptr ä½œç”¨åŸŸ</h1>

<p><code class="language-plaintext highlighter-rouge">shared_ptr</code> ä¼šéšç€ä½œç”¨åŸŸç»“æŸè€Œå‡1ã€‚ä½†å¦‚æœè¿™ä¸ªæŒ‡é’ˆè¢«å‡½æ•°è¿”å›ï¼Œåˆ™è®¡æ•°ä¸ä¼šå‡1 ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">T</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">make_share</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="c1">// è¿”å›ä¸€ä¸ª share_ptr ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆ</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡½æ•°ç»“æŸä¹‹åï¼Œp è¿™ä½œç”¨åŸŸåŒå˜é‡ï¼Œä¼šå‡1.</span>
<span class="kt">void</span> <span class="nf">use_factory</span><span class="p">(</span><span class="n">T</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡½æ•°ç»“æŸä¹‹å p è¿”å›ï¼Œæ‰€ä»¥è®¡æ•°ä¸ä¼šå‡1.</span>
<span class="k">auto</span> <span class="nf">use_factory</span><span class="p">(</span><span class="n">T</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="shared_ptr-ä¸-new-çš„ä½¿ç”¨">shared_ptr ä¸ new çš„ä½¿ç”¨</h1>

<p>1ã€<code class="language-plaintext highlighter-rouge">new</code> å®Œå¯¹è±¡åï¼Œå¯ä»¥ç”¨ <code class="language-plaintext highlighter-rouge">shared_ptr</code> æŒ‡å‘å®ƒã€‚</p>

<p>2ã€æ™ºèƒ½æŒ‡é’ˆçš„æ„é€ å‡½æ•°æ˜¯ <code class="language-plaintext highlighter-rouge">explicit</code> ã€‚å¿…é¡»ä½¿ç”¨<strong>ç›´æ¥åˆå§‹åŒ–å½¢å¼</strong>æ¥åˆå§‹åŒ–ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ(å¦‚ä¸‹é¢ä¾‹å­)ã€‚</p>

<p>3ã€å‡½æ•°æƒ³è¿”å›åˆ›å»ºåçš„å†…å­˜æŒ‡é’ˆæ—¶ï¼Œ å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">share_ptr</code> æ–¹å¼è¿”å›ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">User</span><span class="p">();</span> <span class="c1">// é”™è¯¯ </span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p2</span><span class="p">(</span><span class="k">new</span> <span class="nf">User</span><span class="p">());</span>  <span class="c1">//æ­£ç¡® åˆå§‹åŒ–å½¢å¼æ¥åˆå§‹åŒ–ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="c1">//é”™ è¯¯</span>
<span class="p">}</span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="p">));</span> <span class="c1">// æ­£ç¡®</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="shared_ptr--å‡½æ•°ä¼ å‚">shared_ptr  å‡½æ•°ä¼ å‚</h1>

<p>å½“ <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç”¨åˆ°å‚æ•°ä¼ å‚æ—¶ï¼Œç”¨çš„æ˜¯<strong>ä¼ å€¼è°ƒç”¨</strong>ã€‚è°ƒç”¨å‡½æ•°æ—¶ï¼Œè¯¥ <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç±»æ‰€æŒ‡å‘çš„å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ 1ã€‚è°ƒç”¨å®Œæˆä¹‹åï¼Œå¼•ç”¨è®¡æ•°åˆå‡1 ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">User</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="c1">// todo...  </span>
<span class="p">}</span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">string</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">));</span> <span class="c1">// åˆå§‹åŒ–ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡</span>
 
 <span class="n">User</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">// p æ‰€æŒ‡çš„å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ  1 </span>

<span class="c1">//User å‡½æ•°è°ƒç”¨ä¹‹åï¼Œp æ‰€æŒ‡çš„å¼•ç”¨è®¡æ•°å‡1</span>

<span class="n">stirng</span> <span class="n">p3</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="c1">// OK å¯¹è±¡çš„è®¡æ•°æ²¡æœ‰åˆ°å‡åˆ°0ï¼Œæ‰€ä»¥æ­£å¸¸</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">User</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="c1">// todo ...</span>
<span class="p">}</span>

<span class="n">string</span> <span class="o">*</span><span class="n">p1</span><span class="p">(</span><span class="k">new</span> <span class="n">string</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">));</span>

<span class="n">User</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span> <span class="c1">// ERRORï¼Œ è¦å…ˆæŠŠ string * è½¬æ¢ä¸ºä¸€ä¸ªshared_ptr&lt;string&gt;</span>

<span class="n">User</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p1</span><span class="p">));</span> <span class="c1">//åˆæ³•çš„ï¼Œä½†æ˜¯ User å‡½æ•°è¿”å›ä¹‹åå†…å­˜ä¼šè¢«é‡Šæ”¾ </span>

<span class="n">string</span>  <span class="n">p2</span><span class="o">=*</span><span class="n">p1</span><span class="p">;</span> <span class="c1">//ERROR ï¼Œp1æ‰€æŒ‡çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾äº†ã€‚User ä¹‹å å¯¹è±¡çš„è®¡æ•°å·²ç»ä¸º0 ã€‚æ‰€ä»¥å†…å­˜å·²ç»è¢«é‡Šæ”¾ã€‚</span>
</code></pre></div></div>

<h1 id="get-å‡½æ•°">get å‡½æ•°</h1>

<p>1ã€get å‡½æ•°è¿”å›ä¸€ä¸ªå†…ç½®æŒ‡é’ˆï¼ˆæ™®é€šæŒ‡é’ˆï¼‰ï¼ŒæŒ‡å‘æ™ºèƒ½æŒ‡é’ˆæ‰€ç®¡ç†çš„å¯¹è±¡ã€‚</p>

<p>2ã€å¯¹ get å‡½æ•°è¿”å›ä¸è¦å†ç”¨å›æ™ºèƒ½æŒ‡é’ˆï¼Œ å¯èƒ½ä¼šé€ æˆå¯¹è±¡è®¡æ•°è¢«å‡åˆ°0 è€Œå†…å­˜å¯¹è±¡è¢«é‡Šæ”¾ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="k">new</span> <span class="nf">User</span><span class="p">(</span><span class="err">â€œ</span><span class="n">Boss</span><span class="err">â€</span><span class="p">));</span> <span class="c1">// å¼•ç”¨è®¡æ•°å˜ä¸º1</span>

<span class="n">User</span> <span class="o">*</span><span class="n">q</span><span class="o">=</span><span class="n">ptr</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="c1">//OK ä½¿ç”¨ q éœ€è¦æ³¨æ„ï¼Œä¸è¦è®©å®ƒç®¡ç†çš„æŒ‡é’ˆè¢«é‡Šæ”¾</span>

<span class="p">{</span> <span class="c1">// æ–°è¯­å¥å—</span>
	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">);</span> <span class="c1">// ç”¨ q åˆå§‹åŒ–ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡</span>
<span class="p">}</span> <span class="c1">//è¯­å¥å—ç»“æŸä¹‹åï¼Œæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡é‡Šæ”¾å®ƒæ‰€æŒ‡çš„å†…å­˜ç©ºé—´</span>

<span class="kt">int</span> <span class="n">foo</span><span class="o">=*</span><span class="n">p</span><span class="p">;</span><span class="c1">// ERROR ï¼Œpæ‰€æŒ‡çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾äº†</span>

</code></pre></div></div>

<h1 id="reset-å’Œ-unique-å‡½æ•°">reset å’Œ unique å‡½æ•°</h1>

<p>1ã€<code class="language-plaintext highlighter-rouge">reset</code> å‡½æ•°ä¼šå°† <code class="language-plaintext highlighter-rouge">shared_prt</code> ç±»åŸå…ˆæ‰€æŒ‡çš„å†…å­˜å¯¹è±¡å¼•ç”¨è®¡æ•°å‡1ï¼Œå¹¶ä¸”æŒ‡å‘äºä¸€å—æ–°çš„å†…ã€‚</p>

<p>2ã€<code class="language-plaintext highlighter-rouge">unique</code> å‡½æ•°æ£€æŸ¥è‡ªå·±æ˜¯å¦ä¸ºå½“å‰å¯¹è±¡çš„å”¯ä¸€æ™ºèƒ½æŒ‡é’ˆã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>

<span class="n">shared_ptr</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="nf">User</span><span class="p">(</span><span class="s">"name"</span><span class="p">));</span> <span class="c1">// OK, ptr æŒ‡å‘ä¸€ä¸ªæ–°å¯¹è±¡</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"World Boss"</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">.</span><span class="n">unique</span><span class="p">())</span> <span class="c1">// ptr æ˜¯æƒŸä¸€æŒ‡å‘å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆ</span>
	<span class="n">ptr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="nf">string</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>  <span class="c1">// æŒ‡å‘ä¸€ä¸ªæ–°çš„å†…å­˜</span>
	
<span class="o">*</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">newVal</span><span class="p">;</span> <span class="c1">// å¯ä»¥æ“ä½œæ–°çš„å†…å­˜</span>
</code></pre></div></div>

<h1 id="shared_prt-å¼‚å¸¸å¤„ç†">shared_prt å¼‚å¸¸å¤„ç†</h1>

<p>å¦‚æœç¨‹åºå‘ç”Ÿå¼‚å¸¸è¿‡æ—©çš„ç»“æŸï¼Œæ™ºèƒ½æŒ‡é’ˆä¹Ÿèƒ½ç¡®ä¿åœ¨å†…å­˜ä¸å†éœ€è¦æ—¶å°†å…¶é‡Šæ”¾ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">voif</span> <span class="nf">test_exception</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="k">new</span> <span class="n">string</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">));</span>
	<span class="c1">//  æŠ›å‡ºå¼‚å¸¸ï¼Œå‡½æ•°ç»ˆæ­¢</span>
<span class="p">}</span>
<span class="c1">// shared_ptr è‡ªåŠ¨é‡Šæ”¾å†…å­˜</span>

</code></pre></div></div>

<h1 id="shared_prt--åˆ é™¤å™¨">shared_prt  åˆ é™¤å™¨</h1>

<p><code class="language-plaintext highlighter-rouge">shared_ptr</code> ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œä¼šè°ƒç”¨é»˜è®¤çš„ææ„å‡½æ•°æ¥é‡Šæ”¾è‡ªå·±æ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´ã€‚å¼€å‘äººå‘˜å¯ä»¥é‡ç½® <code class="language-plaintext highlighter-rouge">shared_prt</code> ç±»åˆ é™¤å™¨ã€‚åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶å°±ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªåˆ é™¤å™¨ã€‚
å¦‚ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
<span class="kt">void</span> <span class="nf">Userfree</span><span class="p">(</span><span class="n">User</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="n">InfoFree</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span> 

<span class="kt">void</span> <span class="n">Proc</span><span class="p">(</span><span class="n">User</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">connection</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">Userfree</span><span class="p">);</span> <span class="c1">// é‡Šæ”¾æ—¶ä½¿ç”¨è¿™ä¸ª Userfree æ¥ææ„æ‰å¯¹è±¡</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="shared_prt-ä¸åŠ¨æ€æ•°ç»„çš„ä½¿ç”¨">shared_prt ä¸åŠ¨æ€æ•°ç»„çš„ä½¿ç”¨</h1>

<p><code class="language-plaintext highlighter-rouge">shared_ptr</code> ä¸ç›´æ¥æ”¯æŒç®¡ç†åŠ¨æ€æ•°ç»„ã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç®¡ç†åŠ¨æ€æ•°ç»„ï¼Œå¿…é¡»æä¾›è‡ªå·±å®šä¹‰çš„åˆ é™¤å™¨ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æœ¬ä¾‹ä¸­ï¼Œä¼ é€’ç»™shared_pträ¸€ä¸ªlambdaä½œä¸ºåˆ é™¤å™¨ </span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sp</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="p">[](</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">delete</span><span class="p">[]</span> <span class="n">p</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span> 

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sp2</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">3</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span> <span class="p">[](</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">delete</span><span class="p">[]</span> <span class="n">p</span><span class="p">;</span> <span class="p">});</span> <span class="c1">// lambda å®šä¹‰é‡Šæ”¾å‡½æ•°</span>

<span class="n">sp2</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> <span class="c1">// è°ƒç”¨ lambda é‡Šæ”¾æ•°ç»„</span>
</code></pre></div></div>

<hr />

<p>èµ„æ–™å‚è€ƒï¼š</p>

<p>1ã€è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼š <a href="https://cloud.tencent.com/developer/article/1784374">C++(STL):03â€”æ™ºèƒ½æŒ‡é’ˆä¹‹shared_ptr</a></p>

:ET