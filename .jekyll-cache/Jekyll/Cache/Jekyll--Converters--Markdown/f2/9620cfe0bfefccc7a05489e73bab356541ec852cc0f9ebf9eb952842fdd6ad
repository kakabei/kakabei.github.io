I"ä@<p>TCP æœåŠ¡ç«¯ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// åˆ›å»º socket</span>
    <span class="kt">int</span> <span class="n">server_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to create socket."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ç»‘å®š socket</span>
    <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to bind socket."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ç›‘å¬ç«¯å£</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to listen on port 8080."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Server started. Listening on port 8080..."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>
    <span class="kt">int</span> <span class="n">client_socket</span><span class="p">;</span>
    <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">client_addr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>

    <span class="n">client_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_addr_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to accept connection."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Client connected. IP address: "</span> <span class="o">&lt;&lt;</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Received "</span> <span class="o">&lt;&lt;</span> <span class="n">num_bytes</span> <span class="o">&lt;&lt;</span> <span class="s">" bytes of data from client: "</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// å…³é—­è¿æ¥</span>
    <span class="n">close</span><span class="p">(</span><span class="n">client_socket</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>TCP å®¢æˆ·ç«¯ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// åˆ›å»ºå¥—æ¥å­—</span>
    <span class="kt">int</span> <span class="n">client_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to create socket</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// è®¾ç½®æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_addr</span><span class="p">{};</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>

    <span class="c1">// è¿æ¥æœåŠ¡å™¨</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to connect server</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// å‘é€æ•°æ®</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello, server!"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Failed to send data</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// å…³é—­è¿æ¥</span>
    <span class="n">close</span><span class="p">(</span><span class="n">client_socket</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<p>TCP ä¸‰æ¬¡æ¡æ‰‹æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">listen</code> ä¹‹åï¼Œ<code class="language-plaintext highlighter-rouge">accept</code> ä¹‹å‰å®Œæˆçš„ã€‚</p>

<p>åœ¨ TCP æœåŠ¡å™¨ç«¯å¯åŠ¨åï¼Œé¦–å…ˆéœ€è¦è°ƒç”¨ <code class="language-plaintext highlighter-rouge">socket()</code> å‡½æ•°åˆ›å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">socket</code>ï¼Œç„¶åé€šè¿‡ <code class="language-plaintext highlighter-rouge">bind()</code> å‡½æ•°ç»‘å®š <code class="language-plaintext highlighter-rouge">socket</code> åˆ°ä¸€ä¸ªåœ°å€ï¼ˆé€šå¸¸æ˜¯æœåŠ¡å™¨çš„ IP åœ°å€å’Œç«¯å£å·ï¼‰ã€‚ä¹‹åï¼Œéœ€è¦è°ƒç”¨ <code class="language-plaintext highlighter-rouge">listen()</code> å‡½æ•°ï¼Œå¼€å§‹ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚è¿™æ—¶ï¼ŒTCP æœåŠ¡å™¨å¤„äº <code class="language-plaintext highlighter-rouge">LISTEN</code> çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚</p>

<p>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SYN</code> æŠ¥æ–‡ï¼Œè¡¨ç¤ºè¯·æ±‚è¿æ¥ã€‚æ­¤æ—¶ï¼ŒæœåŠ¡å™¨ç«¯æ”¶åˆ°è¿æ¥è¯·æ±‚åï¼Œä¼šå‘é€ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SYN-ACK</code> æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œè¡¨ç¤ºç¡®è®¤è¿æ¥è¯·æ±‚ï¼Œå¹¶å‘å®¢æˆ·ç«¯å‘é€ç¡®è®¤å·ã€‚å½“å®¢æˆ·ç«¯æ”¶åˆ° <code class="language-plaintext highlighter-rouge">SYN-ACK</code> æŠ¥æ–‡åï¼Œä¼šå‘é€ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">ACK</code> æŠ¥æ–‡ç»™æœåŠ¡å™¨ç«¯ï¼Œè¡¨ç¤ºç¡®è®¤è¿æ¥æˆåŠŸã€‚</p>

<p>å½“è¿™ä¸‰æ¬¡æ¡æ‰‹å®Œæˆåï¼ŒæœåŠ¡å™¨è°ƒç”¨ <code class="language-plaintext highlighter-rouge">accept()</code> å‡½æ•°æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œæ­¤æ—¶æœåŠ¡å™¨å¯ä»¥å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚</p>

<p>å®¢æˆ·ç«¯çš„TCPä¸‰æ¬¡æ¡æ‰‹æ˜¯åœ¨ connect å‡½æ•°ä¹‹åè¿›è¡Œçš„ã€‚å½“å®¢æˆ·ç«¯è°ƒç”¨ connect å‡½æ•°æ—¶ï¼Œå®ƒå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªSYNæŠ¥æ–‡ï¼Œè¯·æ±‚å»ºç«‹è¿æ¥ã€‚æœåŠ¡å™¨æ”¶åˆ°SYNæŠ¥æ–‡åï¼Œä¼šå‘é€ä¸€ä¸ªSYN+ACKæŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œè¡¨ç¤ºåŒæ„å»ºç«‹è¿æ¥ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„SYN+ACKæŠ¥æ–‡åï¼Œä¼šå†æ¬¡å‘é€ä¸€ä¸ªACKæŠ¥æ–‡ï¼Œè¡¨ç¤ºç¡®è®¤è¿æ¥å·²å»ºç«‹ã€‚è¿™æ ·ï¼ŒTCPä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œè¿æ¥å°±å»ºç«‹èµ·æ¥äº†ã€‚</p>

<p>ä» <code class="language-plaintext highlighter-rouge">read</code> è¿”å› 0 è¡¨ç¤ºè¿œç¨‹å·²å…³é—­è¿æ¥ï¼Œå³TCPè¿æ¥å·²ç»å…³é—­ã€‚</p>

<p>å› ä¸ºåœ¨ TCP è¿æ¥ä¸­ï¼Œå½“ä¸€æ–¹æ”¶åˆ°å¯¹ç«¯çš„ FIN æŠ¥æ–‡æ®µå¹¶è¿”å›äº† ACK æŠ¥æ–‡æ®µåï¼Œä¼šè¿›å…¥ CLOSE_WAIT çŠ¶æ€ï¼Œè¡¨ç¤ºè‡ªå·±å·²ç»æ²¡æœ‰è¦å‘é€çš„æ•°æ®äº†ï¼Œä½†æ˜¯å¯¹ç«¯å¯èƒ½è¿˜ä¼šå‘é€ä¸€äº›æ•°æ®è¿‡æ¥ã€‚å½“å¯¹ç«¯ä¹Ÿæ²¡æœ‰æ•°æ®è¦å‘é€æ—¶ï¼Œä¼šå‘é€ä¸€ä¸ª FIN æŠ¥æ–‡æ®µï¼Œè¡¨ç¤ºå¯¹ç«¯ä¹Ÿå·²ç»å…³é—­è¿æ¥ï¼Œè¿™æ—¶å€™æœ¬åœ°ä¼šå›å¤ä¸€ä¸ª ACK æŠ¥æ–‡æ®µï¼Œè¡¨ç¤ºå·²ç»æ”¶åˆ°äº†å¯¹ç«¯çš„ FIN æŠ¥æ–‡æ®µï¼Œå¹¶è¿›å…¥ LAST_ACK çŠ¶æ€ã€‚åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œå¦‚æœå¯¹ç«¯ä¹Ÿç¡®è®¤äº† ACK æŠ¥æ–‡æ®µï¼Œé‚£ä¹ˆè¿æ¥å°±çœŸæ­£å…³é—­äº†ã€‚æ­¤æ—¶ï¼Œæœ¬åœ°å¦‚æœè¿˜ç»§ç»­è°ƒç”¨ readï¼Œä¼šè¿”å›0ï¼Œè¡¨ç¤ºè¿æ¥å·²ç»å…³é—­ã€‚</p>
:ET