I"²<h1 id="ä¸€-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¿¡å·é‡">ä¸€ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¿¡å·é‡</h1>

<p>ä¸ºäº†é˜²æ­¢å‡ºç°å› å¤šä¸ªç¨‹åºåŒæ—¶è®¿é—®ä¸€ä¸ªå…±äº«èµ„æºè€Œå¼•å‘çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œå®ƒå¯ä»¥é€šè¿‡ç”Ÿæˆå¹¶ä½¿ç”¨<strong>ä»¤ç‰Œ</strong>æ¥æˆæƒï¼Œåœ¨ä»»ä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹è®¿é—®ä»£ç çš„ä¸´ç•ŒåŒºåŸŸã€‚ä¸´ç•ŒåŒºåŸŸæ˜¯æŒ‡æ‰§è¡Œæ•°æ®æ›´æ–°çš„ä»£ç éœ€è¦ç‹¬å å¼åœ°æ‰§è¡Œã€‚è€Œä¿¡å·é‡å°±å¯ä»¥æä¾›è¿™æ ·çš„ä¸€ç§è®¿é—®æœºåˆ¶ï¼Œè®©ä¸€ä¸ªä¸´ç•ŒåŒºåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®å®ƒï¼Œ ä¹Ÿå°±æ˜¯è¯´ä¿¡å·é‡æ˜¯ç”¨æ¥è°ƒåè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®çš„ã€‚å…¶ä¸­å…±äº«å†…å­˜çš„ä½¿ç”¨å°±è¦ç”¨åˆ°ä¿¡å·é‡ã€‚</p>

<h1 id="äºŒ-ä¿¡å·é‡çš„å·¥ä½œåŸç†">äºŒ ä¿¡å·é‡çš„å·¥ä½œåŸç†</h1>

<p>ç”±äºä¿¡å·é‡åªèƒ½è¿›è¡Œä¸¤ç§æ“ä½œç­‰å¾…å’Œå‘é€ä¿¡å·ï¼Œå³ P(sv) å’Œ V(sv),ä»–ä»¬çš„è¡Œä¸ºæ˜¯è¿™æ ·çš„ï¼š</p>

<p>P(sv)ï¼šå¦‚æœsvçš„å€¼å¤§äºé›¶ï¼Œå°±ç»™å®ƒå‡1ï¼›å¦‚æœå®ƒçš„å€¼ä¸ºé›¶ï¼Œå°±æŒ‚èµ·è¯¥è¿›ç¨‹çš„æ‰§è¡Œ.</p>

<p>V(sv)ï¼šå¦‚æœæœ‰å…¶ä»–è¿›ç¨‹å› ç­‰å¾…svè€Œè¢«æŒ‚èµ·ï¼Œå°±è®©å®ƒæ¢å¤è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿›ç¨‹å› ç­‰å¾…svè€ŒæŒ‚èµ·ï¼Œå°±ç»™å®ƒåŠ  1.</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹å…±äº«ä¿¡å·é‡ svï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œäº† P(sv) æ“ä½œï¼Œå®ƒå°†å¾—åˆ°ä¿¡å·é‡ï¼Œå¹¶å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºï¼Œä½¿ sv å‡1ã€‚è€Œç¬¬äºŒä¸ªè¿›ç¨‹å°†è¢«é˜»æ­¢è¿›å…¥ä¸´ç•ŒåŒºï¼Œå› ä¸º å½“å®ƒè¯•å›¾æ‰§è¡Œ P(sv) æ—¶ï¼Œsv ä¸º 0ï¼Œå®ƒä¼šè¢«æŒ‚èµ·ä»¥ç­‰å¾…ç¬¬ä¸€ä¸ªè¿›ç¨‹ç¦»å¼€ä¸´ç•ŒåŒºåŸŸå¹¶æ‰§è¡Œ V(sv) é‡Šæ”¾ä¿¡å·é‡ï¼Œè¿™æ—¶ç¬¬äºŒä¸ªè¿›ç¨‹å°±å¯ä»¥æ¢å¤æ‰§è¡Œã€‚</p>

<h1 id="ä¸‰-linux-çš„ä¿¡å·é‡æœºåˆ¶">ä¸‰ Linux çš„ä¿¡å·é‡æœºåˆ¶</h1>

<p>Linux æä¾›äº†ä¸€ç»„ç²¾å¿ƒè®¾è®¡çš„ä¿¡å·é‡æ¥å£æ¥å¯¹ä¿¡å·è¿›è¡Œæ“ä½œï¼Œå®ƒä»¬ä¸åªæ˜¯é’ˆå¯¹äºŒè¿›åˆ¶ä¿¡å·é‡ï¼Œä¸‹é¢å°†ä¼šå¯¹è¿™äº›å‡½æ•°è¿›è¡Œä»‹ç»ï¼Œä½†è¯·æ³¨æ„ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ç”¨æ¥å¯¹æˆç»„çš„ä¿¡å·é‡å€¼è¿›è¡Œæ“ä½œçš„ã€‚å®ƒä»¬å£°æ˜åœ¨å¤´æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">sys/sem.h</code> ä¸­ã€‚</p>

<h1 id="å››-ä¿¡å·å·ç›¸å…³çš„ä¸¤ä¸ªç»“æ„ä½“">å›› ä¿¡å·å·ç›¸å…³çš„ä¸¤ä¸ªç»“æ„ä½“</h1>

<p>å†…æ ¸ä¸ºæ¯ä¸ªä¿¡å·é‡é›†åˆè®¾ç½®äº†ä¸€ä¸ªsemid_dsç»“æ„</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">semid_ds</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ipc_permsem_perm</span> <span class="p">;</span>
    <span class="n">structsem</span><span class="o">*</span>    <span class="n">sem_base</span> <span class="p">;</span> <span class="c1">//ä¿¡å·æ•°ç»„æŒ‡é’ˆ</span>
    <span class="n">ushort</span>        <span class="n">sem_nsem</span> <span class="p">;</span> <span class="c1">//æ­¤é›†ä¸­ä¿¡å·ä¸ªæ•°</span>
    <span class="kt">time_t</span>        <span class="n">sem_otime</span> <span class="p">;</span> <span class="c1">//æœ€åä¸€æ¬¡semopæ—¶é—´</span>
    <span class="kt">time_t</span>        <span class="n">sem_ctime</span> <span class="p">;</span> <span class="c1">//æœ€åä¸€æ¬¡åˆ›å»ºæ—¶é—´</span>
<span class="p">}</span> <span class="p">;</span>
</code></pre></div></div>

<p>æ¯ä¸ªä¿¡å·é‡ç”±ä¸€ä¸ªæ— åç»“æ„è¡¨ç¤ºï¼Œå®ƒè‡³å°‘åŒ…å«ä¸‹åˆ—æˆå‘˜ï¼š ï¼ˆè¿™ä¸ªæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿï¼Ÿï¼‰</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span>  <span class="p">{</span>
    <span class="n">ushort_t</span>  <span class="n">semval</span> <span class="p">;</span>  <span class="c1">//ä¿¡å·é‡çš„å€¼</span>
    <span class="kt">short</span>     <span class="n">sempid</span> <span class="p">;</span>  <span class="c1">//æœ€åä¸€ä¸ªè°ƒç”¨semopçš„è¿›ç¨‹ID</span>
    <span class="n">ushort</span>    <span class="n">semncnt</span> <span class="p">;</span> <span class="c1">//ç­‰å¾…è¯¥ä¿¡å·é‡å€¼å¤§äºå½“å‰å€¼çš„è¿›ç¨‹æ•°ï¼ˆä¸€æœ‰è¿›ç¨‹é‡Šæ”¾èµ„æº å°±è¢«å”¤é†’ï¼‰</span>
    <span class="n">ushort</span>    <span class="n">semzcnt</span> <span class="p">;</span> <span class="c1">//ç­‰å¾…è¯¥ä¿¡å·é‡å€¼ç­‰äº0çš„è¿›ç¨‹æ•°</span>
<span class="p">}</span> <span class="p">;</span> 
</code></pre></div></div>

<h3 id="äº”-ä¿¡å·é‡çš„ä½¿ç”¨">äº” ä¿¡å·é‡çš„ä½¿ç”¨</h3>

<p>1ã€åˆ›å»ºä¿¡å·é‡</p>

<p>semgetå‡½æ•°åˆ›å»ºä¸€ä¸ªä¿¡å·é‡é›†æˆ–è®¿é—®ä¸€ä¸ªå·²å­˜åœ¨çš„ä¿¡å·é‡é›†ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
</span><span class="kt">int</span>  <span class="nf">semget</span> <span class="p">(</span><span class="n">key_t</span> <span class="n">key</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">nsem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">)</span> <span class="p">;</span>
</code></pre></div></div>

<p>è¿”å›å€¼æ˜¯ä¸€ä¸ªç§°ä¸ºä¿¡å·é‡æ ‡è¯†ç¬¦çš„æ•´æ•°ï¼Œsemopå’Œsemctlå‡½æ•°å°†ä½¿ç”¨å®ƒã€‚
å‚æ•°nsemæŒ‡å®šé›†åˆä¸­çš„ä¿¡å·é‡æ•°ã€‚ï¼ˆè‹¥ç”¨äºè®¿é—®ä¸€ä¸ªå·²å­˜åœ¨çš„é›†åˆï¼Œé‚£å°±å¯ä»¥æŠŠè¯¥å‚æ•°æŒ‡å®šä¸º0ï¼‰
å‚æ•° oflag å¯ä»¥æ˜¯ SEM_R(read) å’Œ SEM_A(alter) å¸¸å€¼çš„ç»„åˆã€‚ï¼ˆæ‰“å¼€æ—¶ç”¨åˆ°ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ IPC_CREAT æˆ– IPC_EXCL ;</p>

<p>2ã€æ‰“å¼€ä¿¡å·é‡</p>

<p>ä½¿ç”¨ semget æ‰“å¼€ä¸€ä¸ªä¿¡å·é‡é›†åï¼Œå¯¹å…¶ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªä¿¡å·é‡çš„æ“ä½œå°±ä½¿ç”¨ semop(opâ€“operate) å‡½æ•°æ¥æ‰§è¡Œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
</span><span class="kt">int</span>  <span class="nf">semop</span> <span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">sembuf</span> <span class="o">*</span> <span class="n">opsptr</span><span class="p">,</span>  <span class="kt">size_t</span> <span class="n">nops</span><span class="p">)</span> <span class="p">;</span>
</code></pre></div></div>

<p>å‚æ•° opsptr æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªä¿¡å·é‡æ“ä½œæ•°ç»„ï¼Œä¿¡å·é‡æ“ä½œç”±sembufç»“æ„è¡¨ç¤ºï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">sembuf</span><span class="p">{</span>  
    <span class="kt">short</span> <span class="n">sem_num</span><span class="p">;</span>   <span class="c1">// é™¤éä½¿ç”¨ä¸€ç»„ä¿¡å·é‡ï¼Œå¦åˆ™å®ƒä¸º0  </span>
    <span class="kt">short</span> <span class="n">sem_op</span><span class="p">;</span>    <span class="c1">// ä¿¡å·é‡åœ¨ä¸€æ¬¡æ“ä½œä¸­éœ€è¦æ”¹å˜çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯ä¸¤ä¸ªæ•°ï¼Œ</span>
                     <span class="c1">// ä¸€ä¸ªæ˜¯-1ï¼Œå³Pï¼ˆç­‰å¾…ï¼‰æ“ä½œï¼Œä¸€ä¸ªæ˜¯+1ï¼Œå³Vï¼ˆå‘é€ä¿¡å·ï¼‰æ“ä½œ  </span>
    <span class="kt">short</span> <span class="n">sem_flg</span><span class="p">;</span>   <span class="c1">// é€šå¸¸ä¸ºSEM_UNDO,ä½¿æ“ä½œç³»ç»Ÿè·Ÿè¸ªä¿¡å·ï¼Œå¹¶åœ¨è¿›ç¨‹æ²¡æœ‰é‡Šæ”¾è¯¥ä¿¡å·é‡è€Œç»ˆæ­¢æ—¶ï¼Œ</span>
                     <span class="c1">// æ“ä½œç³»ç»Ÿé‡Šæ”¾ä¿¡å·é‡  </span>
<span class="p">};</span>  
</code></pre></div></div>

<ul>
  <li>å‚æ•° nops è§„å®š opsptr æ•°ç»„ä¸­å…ƒç´ ä¸ªæ•°ã€‚</li>
  <li>sem_op å€¼ï¼š</li>
</ul>

<p>ï¼ˆ1ï¼‰è‹¥ sem_op ä¸ºæ­£ï¼Œè¿™å¯¹åº”äºè¿›ç¨‹é‡Šæ”¾å ç”¨çš„èµ„æºæ•°ã€‚sem_opå€¼åŠ åˆ°ä¿¡å·é‡çš„å€¼ä¸Šã€‚ï¼ˆVæ“ä½œï¼‰</p>

<p>ï¼ˆ2ï¼‰è‹¥ sem_op ä¸ºè´Ÿ,è¿™è¡¨ç¤ºè¦è·å–è¯¥ä¿¡å·é‡æ§åˆ¶çš„èµ„æºæ•°ã€‚ä¿¡å·é‡å€¼å‡å»sem_opçš„ç»å¯¹å€¼ã€‚ï¼ˆPæ“ä½œï¼‰</p>

<p>ï¼ˆ3ï¼‰è‹¥ sem_op ä¸º0,è¿™è¡¨ç¤ºè°ƒç”¨è¿›ç¨‹å¸Œæœ›ç­‰å¾…åˆ°è¯¥ä¿¡å·é‡å€¼å˜æˆ 0ã€‚</p>

<ul>
  <li>å¦‚æœä¿¡å·é‡å€¼å°äº sem_op çš„ç»å¯¹å€¼ï¼ˆèµ„æºä¸èƒ½æ»¡è¶³è¦æ±‚ï¼‰ï¼Œåˆ™ï¼š</li>
  <li>ï¼ˆ1ï¼‰è‹¥æŒ‡å®šäº† IPC_NOWAITï¼Œåˆ™ semop() å‡ºé”™è¿”å›EAGAINã€‚
ï¼ˆ2ï¼‰è‹¥æœªæŒ‡å®š IPC_NOWAITï¼Œåˆ™ä¿¡å·é‡çš„ semncnt å€¼åŠ  1ï¼ˆå› ä¸ºè°ƒç”¨è¿›ç¨‹å°†è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼‰ï¼Œç„¶åè°ƒç”¨è¿›ç¨‹è¢«æŒ‚èµ·ç›´è‡³ï¼š
â‘ æ­¤ä¿¡å·é‡å˜æˆå¤§äºæˆ–ç­‰äºsem_opçš„ç»å¯¹å€¼ï¼›â‘¡ä»ç³»ç»Ÿä¸­åˆ é™¤äº†æ­¤ä¿¡å·é‡ï¼Œè¿”å›EIDRMï¼›â‘¢è¿›ç¨‹æ•æ‰åˆ°ä¸€ä¸ªä¿¡ å·ï¼Œå¹¶ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›ï¼Œè¿”å›EINTRã€‚ï¼ˆä¸æ¶ˆæ¯é˜Ÿåˆ—çš„é˜»å¡å¤„ç†æ–¹å¼ å¾ˆç›¸ä¼¼ï¼‰</li>
</ul>

<p>3ã€ä¿¡å·é‡æ˜¯æ“ä½œ</p>

<p>semctl å‡½æ•°å¯¹ä¸€ä¸ªä¿¡å·é‡æ‰§è¡Œå„ç§æ§åˆ¶æ“ä½œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
</span><span class="kt">int</span>  <span class="nf">semctl</span> <span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">semnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="cm">/*å¯é€‰å‚æ•°*/</span> <span class="p">)</span> <span class="p">;</span>
</code></pre></div></div>

<p>ç¬¬å››ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå–å†³äºç¬¬ä¸‰ä¸ªå‚æ•°cmdã€‚</p>

<p>å‚æ•°semnumæŒ‡å®šä¿¡å·é›†ä¸­çš„å“ªä¸ªä¿¡å·ï¼ˆæ“ä½œå¯¹è±¡ï¼‰</p>

<p>å‚æ•°cmdæŒ‡å®šä»¥ä¸‹10ç§å‘½ä»¤ä¸­çš„ä¸€ç§,åœ¨semidæŒ‡å®šçš„ä¿¡å·é‡é›†åˆä¸Šæ‰§è¡Œæ­¤å‘½ä»¤ã€‚</p>

<p>IPC_STAT   è¯»å–ä¸€ä¸ªä¿¡å·é‡é›†çš„æ•°æ®ç»“æ„semid_dsï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨semunä¸­çš„bufå‚æ•°ä¸­ã€‚
IPC_SET     è®¾ç½®ä¿¡å·é‡é›†çš„æ•°æ®ç»“æ„semid_dsä¸­çš„å…ƒç´ ipc_permï¼Œå…¶å€¼å–è‡ªsemunä¸­çš„bufå‚æ•°ã€‚
IPC_RMID  å°†ä¿¡å·é‡é›†ä»å†…å­˜ä¸­åˆ é™¤ã€‚
GETALL      ç”¨äºè¯»å–ä¿¡å·é‡é›†ä¸­çš„æ‰€æœ‰ä¿¡å·é‡çš„å€¼ã€‚
GETNCNT  è¿”å›æ­£åœ¨ç­‰å¾…èµ„æºçš„è¿›ç¨‹æ•°ç›®ã€‚
GETPID      è¿”å›æœ€åä¸€ä¸ªæ‰§è¡Œsemopæ“ä½œçš„è¿›ç¨‹çš„PIDã€‚
GETVAL      è¿”å›ä¿¡å·é‡é›†ä¸­çš„ä¸€ä¸ªå•ä¸ªçš„ä¿¡å·é‡çš„å€¼ã€‚
GETZCNT   è¿”å›è¿™åœ¨ç­‰å¾…å®Œå…¨ç©ºé—²çš„èµ„æºçš„è¿›ç¨‹æ•°ç›®ã€‚
SETALL       è®¾ç½®ä¿¡å·é‡é›†ä¸­çš„æ‰€æœ‰çš„ä¿¡å·é‡çš„å€¼ã€‚
SETVAL      è®¾ç½®ä¿¡å·é‡é›†ä¸­çš„ä¸€ä¸ªå•ç‹¬çš„ä¿¡å·é‡çš„å€¼ã€‚</p>

<h1 id="äº”-ä¿¡å·é‡å€¼çš„åˆå§‹åŒ–">äº” ä¿¡å·é‡å€¼çš„åˆå§‹åŒ–</h1>

<p>semgetå¹¶ä¸åˆå§‹åŒ–å„ä¸ªä¿¡å·é‡çš„å€¼ï¼Œè¿™ä¸ªåˆå§‹åŒ–å¿…é¡»é€šè¿‡ä»¥SETVALå‘½ä»¤(è®¾ç½®é›†åˆä¸­çš„ä¸€ä¸ªå€¼)æˆ–SETALLå‘½ä»¤(è®¾ç½®é›†åˆä¸­çš„æ‰€æœ‰å€¼) è°ƒç”¨semctlæ¥å®Œæˆã€‚
SystemVä¿¡å·é‡çš„è®¾è®¡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªä¿¡å·é‡é›†å¹¶å°†å®ƒåˆå§‹åŒ–éœ€ä¸¤æ¬¡å‡½æ•°è°ƒç”¨æ˜¯ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ã€‚ä¸€ä¸ªä¸å®Œå¤‡çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šåœ¨è°ƒç”¨semgetæ—¶æŒ‡å®šIPC_CREAT | IPC_EXCLæ ‡å¿—ï¼Œè¿™æ ·åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆé¦–å…ˆè°ƒç”¨semgetçš„é‚£ä¸ªè¿›ç¨‹ï¼‰åˆ›å»ºæ‰€éœ€ä¿¡å·é‡ï¼Œè¯¥è¿›ç¨‹éšååˆå§‹åŒ–è¯¥ä¿¡å·é‡ã€‚</p>

<h1 id="å…­-ä¾‹å­">å…­ ä¾‹å­</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
</span>
<span class="k">union</span> <span class="n">semun</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">arry</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sem_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_semvalue</span><span class="p">();</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">del_semvalue</span><span class="p">();</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">semaphore_p</span><span class="p">();</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">semaphore_v</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">message</span> <span class="o">=</span> <span class="sc">'X'</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cm">/* åˆ›å»ºä¿¡å·é‡ */</span>
    <span class="n">sem_id</span> <span class="o">=</span> <span class="n">semget</span><span class="p">((</span><span class="n">key_t</span><span class="p">)</span><span class="mi">1234</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mo">0666</span> <span class="o">|</span> <span class="n">IPC_CREAT</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* ç¨‹åºç¬¬ä¸€æ¬¡è¢«è°ƒç”¨ï¼Œåˆå§‹åŒ–ä¿¡å·é‡ */</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">set_semvalue</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to initialize semaphore</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* è®¾ç½®è¦è¾“å‡ºåˆ°å±å¹•ä¸­çš„ä¿¡æ¯ï¼Œå³å…¶å‚æ•°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ */</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* è¿›å…¥ä¸´ç•ŒåŒº */</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">semaphore_p</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* å‘å±å¹•ä¸­è¾“å‡ºæ•°æ® */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="cm">/* æ¸…ç†ç¼“å†²åŒºï¼Œç„¶åä¼‘çœ éšæœºæ—¶é—´ */</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/* ç¦»å¼€ä¸´ç•ŒåŒºå‰å†ä¸€æ¬¡å‘å±å¹•è¾“å‡ºæ•°æ® */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
        <span class="cm">/* ç¦»å¼€ä¸´ç•ŒåŒºï¼Œä¼‘çœ éšæœºæ—¶é—´åç»§ç»­å¾ªç¯ */</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">semaphore_v</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">%d - finished</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* å¦‚æœç¨‹åºæ˜¯ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨ï¼Œåˆ™åœ¨é€€å‡ºå‰åˆ é™¤ä¿¡å·é‡ */</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">del_semvalue</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_semvalue</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* ç”¨äºåˆå§‹åŒ–ä¿¡å·é‡ï¼Œåœ¨ä½¿ç”¨ä¿¡å·é‡å‰å¿…é¡»è¿™æ ·åš */</span>
    <span class="k">union</span> <span class="n">semun</span> <span class="n">sem_union</span><span class="p">;</span>
    <span class="n">sem_union</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semctl</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SETVAL</span><span class="p">,</span> <span class="n">sem_union</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">del_semvalue</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* åˆ é™¤ä¿¡å·é‡ */</span>
    <span class="k">union</span> <span class="n">semun</span> <span class="n">sem_union</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semctl</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="n">sem_union</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to delete semaphore</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">semaphore_p</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* å¯¹ä¿¡å·é‡åšå‡1æ“ä½œï¼Œå³ç­‰å¾…Pï¼ˆsvï¼‰*/</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_b</span><span class="p">;</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_op</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="c1">//P()</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sem_b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"semaphore_p failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">semaphore_v</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾æ“ä½œï¼Œå®ƒä½¿ä¿¡å·é‡å˜ä¸ºå¯ç”¨ï¼Œå³å‘é€ä¿¡å·Vï¼ˆsvï¼‰*/</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_b</span><span class="p">;</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//V()</span>
    <span class="n">sem_b</span><span class="p">.</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">sem_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sem_b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"semaphore_v failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="ä¸ƒ-ä¿¡å·é‡é›†åˆçš„ä¾‹å­">ä¸ƒ ä¿¡å·é‡é›†åˆçš„ä¾‹å­</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;sys/types.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;sys/ipc.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;sys/sem.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;errno.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;string.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;assert.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;time.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span><span class="cpf">&lt;sys/wait.h&gt;</span><span class="c1">    </span><span class="cp">
#define MAX_SEMAPHORE 10   
#define FILE_NAME "test2.c"  
</span>  
<span class="k">union</span> <span class="n">semun</span><span class="p">{</span>  
    <span class="kt">int</span> <span class="n">val</span> <span class="p">;</span>  
    <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span> <span class="p">;</span>  
    <span class="kt">unsigned</span> <span class="kt">short</span>  <span class="o">*</span><span class="n">array</span> <span class="p">;</span>  
    <span class="k">struct</span> <span class="n">seminfo</span> <span class="o">*</span><span class="n">_buf</span> <span class="p">;</span>  
<span class="p">}</span><span class="n">arg</span><span class="p">;</span>  
<span class="k">struct</span> <span class="n">semid_ds</span> <span class="n">sembuf</span><span class="p">;</span>  
  
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>  
<span class="p">{</span>  
    <span class="n">key_t</span> <span class="n">key</span> <span class="p">;</span>  
    <span class="kt">int</span> <span class="n">semid</span> <span class="p">,</span><span class="n">ret</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>   
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_SEMAPHORE</span><span class="p">]</span> <span class="p">;</span>  
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sb</span><span class="p">[</span><span class="n">MAX_SEMAPHORE</span><span class="p">]</span> <span class="p">;</span>  
    <span class="n">pid_t</span> <span class="n">pid</span> <span class="p">;</span>  
      
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">()</span> <span class="p">;</span>  
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  
    <span class="p">{</span>  
        <span class="cm">/* Create process Error! */</span>  
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Create Process Error!:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>  
    <span class="p">}</span>     
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  
    <span class="p">{</span>  
        <span class="cm">/* in parent process !*/</span>          
        <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="sc">'a'</span><span class="p">)</span> <span class="p">;</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="cm">/* in parent process*/</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error in ftok:%s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>     
        <span class="p">}</span>  
  
        <span class="n">semid</span> <span class="o">=</span> <span class="n">semget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">MAX_SEMAPHORE</span><span class="p">,</span><span class="n">IPC_CREAT</span><span class="o">|</span><span class="mo">0666</span><span class="p">);</span>  <span class="c1">//åˆ›å»ºä¿¡å·é‡é›†åˆ</span>
        <span class="k">if</span><span class="p">(</span><span class="n">semid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error in semget:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>   
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>     
        <span class="p">}</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"Semaphore have been initialed successfully in parent process,ID is :%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">semid</span><span class="p">);</span>     
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"parent wake up....</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="cm">/*çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹å¾—åˆ°semaphoreçš„æ—¶å€™è¯·æ±‚semaphoreï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å°†é˜»å¡ç›´è‡³å­è¿›ç¨‹é‡Šæ”¾æ‰semaphore*/</span>  
        <span class="cm">/* æ­¤æ—¶çˆ¶è¿›ç¨‹çš„é˜»å¡æ˜¯å› ä¸ºsemaphore 1 ä¸èƒ½ç”³è¯·ï¼Œå› è€Œå¯¼è‡´çš„è¿›ç¨‹é˜»å¡*/</span>  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SEMAPHORE</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_num</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_op</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>     <span class="cm">/*è¡¨ç¤ºç”³è¯·semaphore*/</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>  
        <span class="p">}</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"parent is asking for resource...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="n">ret</span> <span class="o">=</span> <span class="n">semop</span><span class="p">(</span><span class="n">semid</span> <span class="p">,</span> <span class="n">sb</span> <span class="p">,</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//p() </span>
        <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">printf</span><span class="p">(</span><span class="s">"parent got the resource!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="p">}</span>         
        <span class="cm">/* çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹é€€å‡º */</span>  
        <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"parent exiting .. </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>  
    <span class="p">}</span>  
    <span class="k">else</span>  
    <span class="p">{</span>  
        <span class="cm">/* in child process! */</span>   
        <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="sc">'a'</span><span class="p">)</span> <span class="p">;</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="cm">/* in child process*/</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error in ftok:%s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>     
        <span class="p">}</span>  
  
        <span class="n">semid</span> <span class="o">=</span> <span class="n">semget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">MAX_SEMAPHORE</span><span class="p">,</span><span class="n">IPC_CREAT</span><span class="o">|</span><span class="mo">0666</span><span class="p">);</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">semid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error in semget:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>   
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>     
        <span class="p">}</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"Semaphore have been initialed successfully in child process,ID is:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">semid</span><span class="p">);</span>   
  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SEMAPHORE</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="cm">/* Initial semaphore */</span>  
            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
        <span class="p">}</span>  
        <span class="n">arg</span><span class="p">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>  
        <span class="n">ret</span> <span class="o">=</span> <span class="n">semctl</span><span class="p">(</span><span class="n">semid</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SETALL</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error in semctl in child:%s!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>  
        <span class="p">}</span>         
        <span class="n">printf</span><span class="p">(</span><span class="s">"In child , Semaphore Initailed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
  
        <span class="cm">/*å­è¿›ç¨‹åœ¨åˆå§‹åŒ–äº†semaphoreä¹‹åï¼Œå°±ç”³è¯·è·å¾—semaphore*/</span>  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SEMAPHORE</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>  
        <span class="p">{</span>
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_num</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_op</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>  
        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">semop</span><span class="p">(</span><span class="n">semid</span> <span class="p">,</span> <span class="n">sb</span> <span class="p">,</span> <span class="mi">10</span><span class="p">);</span><span class="c1">//ä¿¡å·é‡0è¢«é˜»å¡</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"å­è¿›ç¨‹ç”³è¯·semaphoreå¤±è´¥ï¼š%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>         
        <span class="p">}</span>         
        <span class="n">printf</span><span class="p">(</span><span class="s">"child got semaphore,and start to sleep 3 seconds!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>    
        <span class="n">printf</span><span class="p">(</span><span class="s">"child wake up .</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SEMAPHORE</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_num</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_op</span> <span class="o">=</span>  <span class="o">+</span><span class="mi">1</span> <span class="p">;</span>  
            <span class="n">sb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>       
        <span class="p">}</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"child start to release the resource...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
        <span class="n">ret</span> <span class="o">=</span> <span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="n">sb</span> <span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="p">;</span>      
        <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"å­è¿›ç¨‹é‡Šæ”¾semaphoreå¤±è´¥:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>  
        <span class="p">}</span>         
        <span class="n">ret</span> <span class="o">=</span> <span class="n">semctl</span><span class="p">(</span><span class="n">semid</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span><span class="n">IPC_RMID</span><span class="p">);</span>  
        <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"semaphoreåˆ é™¤å¤±è´¥:%sï¼</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>  
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>     
        <span class="p">}</span>         
        <span class="n">printf</span><span class="p">(</span><span class="s">"child exiting successfully!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>      
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>         
    <span class="p">}</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
</code></pre></div></div>

<p>ä¿¡å·é‡çš„æ„å›¾åœ¨äºè¿›ç¨‹é—´åŒæ­¥ï¼Œäº’æ–¥é”å’Œæ¡ä»¶å˜é‡çš„æ„å›¾åˆ™åœ¨äºçº¿ç¨‹é—´åŒæ­¥ã€‚ä½†æ˜¯ä¿¡å·é‡ä¹Ÿå¯ç”¨äºçº¿ç¨‹é—´ï¼Œäº’æ–¥é”å’Œæ¡ä»¶å˜é‡ä¹Ÿå¯ç”¨äºè¿›ç¨‹é—´ã€‚æˆ‘ä»¬åº”è¯¥ä½¿ç”¨é€‚åˆå…·ä½“åº”ç”¨çš„é‚£ç»„åŸè¯­ã€‚</p>

:ET