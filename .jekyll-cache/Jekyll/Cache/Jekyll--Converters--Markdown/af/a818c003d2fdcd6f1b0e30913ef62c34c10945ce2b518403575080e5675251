I"ÚW<p>ä¸€ä¸ªäº’æ–¥é”å¯ä»¥è¢« ç”¨æ¥ä¿æŠ¤ä¸€ä¸ªä¸´ç•ŒåŒºæˆ–ä¸€ç»„ç›¸å…³ä¸´ç•ŒåŒºã€‚ä¿è¯åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªGoroutineå¤„äºè¯¥ä¸´ç•ŒåŒºä¹‹å†…</p>

<p>ä¸ºäº†å…‘ç°è¿™ä¿è¯ä¸Šï¼Œæ¯å½“goroutine æƒ³è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œéƒ½è¦å…ˆå¯¹å®ƒè¿›è¡Œé”å®š ï¼Œç¦»å¼€æ—¶ä¸´ç•ŒåŒºæ—¶éƒ½è¦åŠæ—¶åœ°å¯¹å®ƒè¿›è¡Œè§£é”ã€‚</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
 <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"error: %s [%d]"</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>ä½¿ç”¨äº’æ–¥é”æ—¶æœ‰å“ª äº›æ³¨æ„äº‹é¡¹ï¼š</strong></p>

<p>1 ä¸è¦é‡å¤é”å®šäº’æ–¥é”ã€‚</p>

<p>2 ä¸è¦å¿˜è®°è§£é”äº’æ–¥é”ï¼Œå¿…è¦æ—¶ç”¨ defer è¯­å¥</p>

<p>3 ä¸è¦å¯¹æ²¿æœªé”å®šæˆ–è€…å·²ç»è§£é”çš„äº’æ–¥é”è§£é”</p>

<p>4 ä¸è¦åœ¨å¤šä¸ªå‡½æ•°ä¹‹å‰ç›´æ¥ä¼ é€’äº’æ–¥é”</p>

<p>æ­»é”æ—¶æŠ›å‡ºçš„panicæ˜¯å±äºè‡´ä½¿é”™è¯¯ï¼Œéƒ½æ˜¯æ— æ³•è¢«æ¢å¤çš„ï¼Œè°ƒç”¨recoverå‡½æ•°å¯¹å®ƒä»¬èµ·ä¸äº†ä»»ä½•ä½œç”¨ã€‚</p>

<p>äº’æ–¥é”æ˜¯å¼€ç®±å³ç”¨çš„ã€‚sysnc.Mutexç±»å‹ æ˜¯ä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼Œå±äºå€¼ç±»å‹ä¸­çš„ä¸€ç§ï¼ŒæŠŠå®ƒä¼ ç»™ä¸€ä¸ªå‡½æ•°ã€å°†å®ƒä»å‡½æ•°ä¸­è¿”å›ï¼ŒæŠŠå®ƒèµ‹ç»™å…¶ä»–å˜é‡ã€‚è®©å®ƒè¿›å…¥ æŸä¸ªé€šé“éƒ½ä¼šå¯¼è‡´å®ƒçš„å‰¯æœ¬çš„äº§ç”Ÿã€‚
å®ƒä»¬æ˜¯ç‹¬ç«‹çš„ï¼Œéƒ½æ˜¯ä¸åŒçš„äº’æ–¥é”ã€‚</p>

<p><strong>è¯»å†™é”ä¸äº’æ–¥é”æœ‰å“ª å¼‚åŒï¼Ÿ</strong></p>

<p>sync.RWMuteç±»å‹çš„å€¼ä»£è¡¨ã€‚ éƒ½æ˜¯å¼€ç®±å³ç”¨ã€‚ å®ƒæ˜¯æŠŠå¯¹å…±äº«èµ„æºçš„â€œè¯»æ“ä½œâ€å’Œâ€œå†™æ“ä½œâ€åŒºåˆ«å¯¹å¾…ã€‚</p>

<p>æ¯”äº’æ–¥é”æœ‰åˆ—åŠ ç»†è…»çš„è®¿é—®æ§åˆ¶ã€‚</p>

<p>ä¸€ä¸ªè¯»å†™é”ä¸­å®é™…ä¸ŠåŒ…å«äº†ä¸¤ä¸ªé”ï¼Œå³ï¼šè¯»é”å’Œå†™é”ã€‚sync.RWMutexç±»å‹ä¸­çš„Lockæ–¹æ³•å’ŒUnlockæ–¹æ³•åˆ†åˆ«ç”¨äºå¯¹å†™é”è¿›è¡Œé”å®šå’Œè§£é”ï¼Œè€Œå®ƒçš„RLockæ–¹æ³•å’ŒRUnlockæ–¹æ³•åˆ™åˆ†åˆ«ç”¨äºå¯¹è¯»é”è¿›è¡Œé”å®šå’Œè§£é”ã€‚</p>

<p><strong>å¦å¤–ï¼Œå¯¹äºåŒä¸€ä¸ªè¯»å†™é”æ¥è¯´æœ‰å¦‚ä¸‹è§„åˆ™ï¼š</strong></p>

<p>1 åœ¨å†™é”å·²è¢«é”å®šçš„æƒ…å†µä¸‹å†è¯•å›¾é”å®šå†™é”ï¼Œä¼šé˜»å¡å½“å‰çš„ goroutineã€‚</p>

<p>2 åœ¨å†™é”å·²è¢«é”å®šçš„æƒ…å†µä¸‹è¯•å›¾é”å®šè¯»é”ï¼Œä¹Ÿä¼šé˜»å¡å½“å‰çš„ goroutine</p>

<p>3 åœ¨è¯»é”å·²è¢«é”å®šçš„æƒ…å†µä¸‹è¯•å›¾é”å®šå†™é”ï¼ŒåŒæ ·ä¼šé˜»å¡å½“å‰çš„goroutineã€‚</p>

<p>4 åœ¨è¯»é”å·²è¢«é”å®šçš„æƒ…å†µä¸‹å†è¯•å›¾é”å®šè¯»é”ï¼Œå¹¶ä¸ä¼šé˜»å¡å½“å‰çš„goroutineã€‚</p>

<p>æ¢ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œå¯¹äºæŸä¸ªå—åˆ°è¯»å†™é”ä¿æŠ¤çš„å…±äº«èµ„æºï¼Œå¤šä¸ªå†™æ“ä½œä¸èƒ½åŒæ—¶è¿›è¡Œï¼Œå†™æ“ä½œå’Œè¯»æ“ä½œä¹Ÿä¸èƒ½åŒæ—¶è¿›è¡Œï¼Œä½†å¤šä¸ªè¯»æ“ä½œå´å¯ä»¥åŒæ—¶è¿›è¡Œã€‚</p>

<p>go è¯­è¨€ä»£ç   å®ä¾‹ï¼š</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"bytes"</span>
    <span class="s">"errors"</span>
    <span class="s">"fmt"</span>
    <span class="s">"io"</span>
    <span class="s">"log"</span>
    <span class="s">"sync"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="c">// singleHandler ä»£è¡¨å•æ¬¡å¤„ç†å‡½æ•°çš„ç±»å‹ã€‚</span>
<span class="k">type</span> <span class="n">singleHandler</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">data</span> <span class="kt">string</span><span class="p">,</span> <span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>

<span class="c">// handlerConfig ä»£è¡¨å¤„ç†æµç¨‹é…ç½®çš„ç±»å‹ã€‚</span>
<span class="k">type</span> <span class="n">handlerConfig</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">handler</span>   <span class="n">singleHandler</span> <span class="c">// å•æ¬¡å¤„ç†å‡½æ•°ã€‚</span>
    <span class="n">goNum</span>     <span class="kt">int</span>           <span class="c">// éœ€è¦å¯ç”¨çš„goroutineçš„æ•°é‡ã€‚</span>
    <span class="n">number</span>    <span class="kt">int</span>           <span class="c">// å•ä¸ªgoroutineä¸­çš„å¤„ç†æ¬¡æ•°ã€‚</span>
    <span class="n">interval</span>  <span class="n">time</span><span class="o">.</span><span class="n">Duration</span> <span class="c">// å•ä¸ªgoroutineä¸­çš„å¤„ç†é—´éš”æ—¶é—´ã€‚</span>
    <span class="n">counter</span>   <span class="kt">int</span>           <span class="c">// æ•°æ®é‡è®¡æ•°å™¨ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span>
    <span class="n">counterMu</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>    <span class="c">// æ•°æ®é‡è®¡æ•°å™¨ä¸“ç”¨çš„äº’æ–¥é”ã€‚</span>

<span class="p">}</span>

<span class="c">// count ä¼šå¢åŠ è®¡æ•°å™¨çš„å€¼ï¼Œå¹¶ä¼šè¿”å›å¢åŠ åçš„è®¡æ•°ã€‚</span>
<span class="k">func</span> <span class="p">(</span><span class="n">hc</span> <span class="o">*</span><span class="n">handlerConfig</span><span class="p">)</span> <span class="n">count</span><span class="p">(</span><span class="n">increment</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">counterMu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="n">hc</span><span class="o">.</span><span class="n">counterMu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="n">increment</span>
    <span class="k">return</span> <span class="n">hc</span><span class="o">.</span><span class="n">counter</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// mu ä»£è¡¨ä»¥ä¸‹æµç¨‹è¦ä½¿ç”¨çš„äº’æ–¥é”ã€‚</span>
    <span class="c">// åœ¨ä¸‹é¢çš„å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨å³å¯ï¼Œä¸è¦ä¼ é€’ã€‚</span>
    <span class="k">var</span> <span class="n">mu</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>

    <span class="c">// genWriter ä»£è¡¨çš„æ˜¯ç”¨äºç”Ÿæˆå†™å…¥å‡½æ•°çš„å‡½æ•°ã€‚</span>
    <span class="n">genWriter</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">writer</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="n">singleHandler</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">data</span> <span class="kt">string</span><span class="p">,</span> <span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// å‡†å¤‡æ•°æ®ã€‚</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">StampNano</span><span class="p">))</span>
            <span class="c">// å†™å…¥æ•°æ®ã€‚</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="k">defer</span> <span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c">// genReader ä»£è¡¨çš„æ˜¯ç”¨äºç”Ÿæˆè¯»å–å‡½æ•°çš„å‡½æ•°ã€‚</span>
    <span class="n">genReader</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">reader</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="n">singleHandler</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">data</span> <span class="kt">string</span><span class="p">,</span> <span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">buffer</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">reader</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"unsupported reader"</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="c">// è¯»å–æ•°æ®ã€‚</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="k">defer</span> <span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">ReadString</span><span class="p">(</span><span class="sc">'\t'</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c">// buffer ä»£è¡¨ç¼“å†²åŒºã€‚</span>
    <span class="k">var</span> <span class="n">buffer</span> <span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span>

    <span class="c">// æ•°æ®å†™å…¥é…ç½®ã€‚</span>
    <span class="n">writingConfig</span> <span class="o">:=</span> <span class="n">handlerConfig</span><span class="p">{</span>
        <span class="n">handler</span><span class="o">:</span>  <span class="n">genWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">),</span>
        <span class="n">goNum</span><span class="o">:</span>    <span class="m">5</span><span class="p">,</span>
        <span class="n">number</span><span class="o">:</span>   <span class="m">4</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span> <span class="o">*</span> <span class="m">100</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c">// æ•°æ®è¯»å–é…ç½®ã€‚</span>
    <span class="n">readingConfig</span> <span class="o">:=</span> <span class="n">handlerConfig</span><span class="p">{</span>
        <span class="n">handler</span><span class="o">:</span>  <span class="n">genReader</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">),</span>
        <span class="n">goNum</span><span class="o">:</span>    <span class="m">10</span><span class="p">,</span>
        <span class="n">number</span><span class="o">:</span>   <span class="m">2</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span> <span class="o">*</span> <span class="m">100</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c">// sign ä»£è¡¨ä¿¡å·çš„é€šé“ã€‚</span>
    <span class="n">sign</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{},</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">goNum</span><span class="o">+</span><span class="n">readingConfig</span><span class="o">.</span><span class="n">goNum</span><span class="p">)</span>

    <span class="c">// å¯ç”¨å¤šä¸ªgoroutineå¯¹ç¼“å†²åŒºè¿›è¡Œå¤šæ¬¡æ•°æ®å†™å…¥ã€‚</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">goNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">sign</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{}{}</span>
            <span class="p">}()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">number</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">writingConfig</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">handler</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"writer [%d-%d]: error: %s"</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="p">}</span>
                <span class="n">total</span> <span class="o">:=</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"writer [%d-%d]: %s (total: %d)"</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// å¯ç”¨å¤šä¸ªgoroutineå¯¹ç¼“å†²åŒºè¿›è¡Œå¤šæ¬¡æ•°æ®è¯»å–ã€‚</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">readingConfig</span><span class="o">.</span><span class="n">goNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">sign</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{}{}</span>
            <span class="p">}()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">readingConfig</span><span class="o">.</span><span class="n">number</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
                <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">readingConfig</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
                <span class="k">var</span> <span class="n">data</span> <span class="kt">string</span>
                <span class="k">var</span> <span class="n">n</span> <span class="kt">int</span>
                <span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>
                <span class="k">for</span> <span class="p">{</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">readingConfig</span><span class="o">.</span><span class="n">handler</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
                        <span class="k">break</span>
                    <span class="p">}</span>
                    <span class="c">// å¦‚æœè¯»æ¯”å†™å¿«ï¼ˆè¯»æ—¶ä¼šå‘ç”ŸEOFé”™è¯¯ï¼‰ï¼Œé‚£å°±ç­‰ä¸€ä¼šå„¿å†è¯»ã€‚</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">readingConfig</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"reader [%d-%d]: error: %s"</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="p">}</span>
                <span class="n">total</span> <span class="o">:=</span> <span class="n">readingConfig</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"reader [%d-%d]: %s (total: %d)"</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// signNumber ä»£è¡¨éœ€è¦æ¥æ”¶çš„ä¿¡å·çš„æ•°é‡ã€‚</span>
    <span class="n">signNumber</span> <span class="o">:=</span> <span class="n">writingConfig</span><span class="o">.</span><span class="n">goNum</span> <span class="o">+</span> <span class="n">readingConfig</span><span class="o">.</span><span class="n">goNum</span>
    <span class="c">// ç­‰å¾…ä¸Šé¢å¯ç”¨çš„æ‰€æœ‰goroutineçš„è¿è¡Œå…¨éƒ¨ç»“æŸã€‚</span>
    <span class="k">for</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">signNumber</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">{</span>
        <span class="o">&lt;-</span><span class="n">sign</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

:ET