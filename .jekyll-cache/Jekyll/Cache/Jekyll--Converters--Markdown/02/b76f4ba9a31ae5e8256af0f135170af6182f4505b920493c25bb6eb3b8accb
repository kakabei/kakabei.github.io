I",<p>TcpServeræ–°å»ºè¿æ¥çš„ç›¸å…³å‡½æ•°è°ƒç”¨é¡ºåºè§å›¾</p>

<p><img src="/assets/muduo/8-muduo-tcpserver-new-connection.png" alt="" /></p>

<p>TcpServer classçš„åŠŸèƒ½æ˜¯ç®¡ç†accept(2) è·å¾—çš„TcpConnectionã€‚ TcpServeræ˜¯ä¾›ç”¨æˆ·ç›´æ¥ä½¿ç”¨çš„ï¼Œ ç”Ÿå‘½æœŸç”±ç”¨æˆ·æ§åˆ¶ã€‚</p>

<p>ç”¨æˆ·åªéœ€è¦è®¾ç½®å¥½callbackï¼Œå†è°ƒç”¨start() å³å¯ã€‚</p>

<hr />

<p>TcpServerå†…éƒ¨ä½¿ç”¨Acceptoræ¥è·å¾—æ–°è¿æ¥çš„fdã€‚ å®ƒä¿å­˜ç”¨æˆ·æä¾›çš„ConnectionCallbackå’ŒMessageCallbackï¼Œåœ¨æ–°å»ºTcpConnectionçš„æ—¶å€™ä¼šåŸæ ·ä¼ ç»™åè€…ã€‚</p>

<p>TcpServeræŒæœ‰ç›®å‰å­˜æ´»çš„TcpConnectionçš„shared_ ptrï¼ˆå®šä¹‰ä¸ºTcpConnectionPtrï¼‰ï¼Œå› ä¸ºTcpConnectionå¯¹è±¡çš„ç”Ÿå‘½æœŸæ˜¯æ¨¡ç³Šçš„ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æŒæœ‰TcpConnectionPtrã€‚</p>

<p>æ¯ä¸ªTcpConnectionå¯¹è±¡æœ‰ä¸€ä¸ªåå­—ï¼Œè¿™ä¸ªåå­—æ˜¯ç”±å…¶æ‰€å±çš„TcpServeråœ¨åˆ›å»ºTcpConnectionå¯¹è±¡æ—¶ç”Ÿæˆï¼Œåå­—æ˜¯ConnectionMapçš„keyã€‚</p>

<p>åœ¨æ–°è¿æ¥åˆ°è¾¾æ—¶ï¼ŒAcceptorä¼šå›è°ƒnewConnection()ï¼Œ<strong>[newConnection()æ˜¯TcpServerç±»çš„æˆå‘˜å‡½æ•°ï¼Œè¢«è°ƒè®¾ç½®åˆ°Acceptorçš„å›è°ƒä¸­]</strong></p>

<p>åè€…ä¼šåˆ›å»ºTcpConnectionå¯¹è±¡connï¼ŒæŠŠå®ƒåŠ å…¥ConnectionMapï¼Œè®¾ç½®å¥½callbackï¼Œå†è°ƒç”¨conn-&gt;connectEstablished()ï¼Œå…¶ä¸­ä¼šå›è°ƒç”¨æˆ·æä¾›çš„ConnectionCallbackã€‚</p>

<hr />

<p>TcpConnection ç±»çš„ä¸€éƒ¨åˆ†æˆå‘˜ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TcpConnection</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span>
                      <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="nl">private:</span>
  <span class="k">enum</span> <span class="n">StateE</span> <span class="p">{</span> <span class="n">kDisconnected</span><span class="p">,</span> <span class="n">kConnecting</span><span class="p">,</span> <span class="n">kConnected</span><span class="p">,</span> <span class="n">kDisconnecting</span> <span class="p">};</span>
  <span class="kt">void</span> <span class="n">handleRead</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">handleWrite</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">handleClose</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">handleError</span><span class="p">();</span>
  <span class="c1">// void sendInLoop(string&amp;&amp; message);</span>
  <span class="kt">void</span> <span class="n">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">message</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">shutdownInLoop</span><span class="p">();</span>
  <span class="c1">// void shutdownAndForceCloseInLoop(double seconds);</span>
  <span class="kt">void</span> <span class="n">forceCloseInLoop</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">setState</span><span class="p">(</span><span class="n">StateE</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">stateToString</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">startReadInLoop</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">stopReadInLoop</span><span class="p">();</span>

  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
  <span class="n">StateE</span> <span class="n">state_</span><span class="p">;</span>  <span class="c1">// FIXME: use atomic variable</span>
  <span class="kt">bool</span> <span class="n">reading_</span><span class="p">;</span>
  <span class="c1">// we don't expose those classes to client.</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">socket_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="n">channel_</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">InetAddress</span> <span class="n">localAddr_</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">InetAddress</span> <span class="n">peerAddr_</span><span class="p">;</span>
  
  <span class="c1">// ä¸€äº›å›è°ƒå‡½æ•°</span>
  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>        <span class="c1">// è¿™ä¸ªå›è°ƒæ˜¯å¹²å—çš„å‘¢ï¼Ÿ  å°±æ‰“å°æ—¥å¿—ï¼Ÿ</span>
  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>              <span class="c1">// æ¶ˆæ¯å¤„ç†çš„å›è°ƒ</span>

  <span class="c1">/// å‘é€ç¼“å­˜åŒºçš„é«˜æ°´ä½å›è°ƒ highWaterMarkCallback_</span>
  <span class="c1">/// å‘é€ç¼“å­˜åŒºçš„ä½æ°´ä½å›è°ƒ writeCompleteCallback_</span>
  <span class="n">WriteCompleteCallback</span> <span class="n">writeCompleteCallback_</span><span class="p">;</span>  <span class="c1">// å†™æ•°æ®å®Œæˆçš„å›è°ƒ å‘é€ç¼“å­˜åŒºçš„ä½æ°´ä½å›è°ƒ</span>
  <span class="n">HighWaterMarkCallback</span> <span class="n">highWaterMarkCallback_</span><span class="p">;</span>  <span class="c1">// ??? æ„Ÿè§‰è¿™ä¸ªå°±å›è°ƒç»™ä¸Šä¸€å±‚å¤„ç†ï¼Œå¦‚ä¸€ä¸ªæç¤ºä¹‹ç±»çš„</span>
  <span class="n">CloseCallback</span> <span class="n">closeCallback_</span><span class="p">;</span>                  <span class="c1">// å…³é—­é“¾æ¥çš„å›è°ƒ</span>
  
  <span class="kt">size_t</span> <span class="n">highWaterMark_</span><span class="p">;</span>
  <span class="n">Buffer</span> <span class="n">inputBuffer_</span><span class="p">;</span>   <span class="c1">// ä»fdè¯»å‡ºçš„æ•°æ®ç¼“å­˜</span>
  <span class="n">Buffer</span> <span class="n">outputBuffer_</span><span class="p">;</span> <span class="c1">// FIXME: use list&lt;Buffer&gt; as output buffer.  // ä»è¦å‘é€å‡ºå»çš„ç¼“å­˜</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">any</span> <span class="n">context_</span><span class="p">;</span>
  <span class="c1">// FIXME: creationTime_, lastReceiveTime_</span>
  <span class="c1">//        bytesReceived_, bytesSent_</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">TcpConnectionPtr</span><span class="p">;</span>

</code></pre></div></div>

<h4 id="ä»å¤´è¯´èµ·ä¸€ä¸ªæ–°é“¾æ¥çš„åˆ›å»º">ä»å¤´è¯´èµ·ä¸€ä¸ªæ–°é“¾æ¥çš„åˆ›å»ºã€‚</h4>

<p>åˆ›å»ºå‡ºTcpServer çš„å¯¹è±¡ã€‚TcpServer åœ¨æ„é€ å‡½æ•°ä¸­å°± new å‡ºAcceptor() ã€‚åˆæŠŠ &amp;TcpServer::newConnection è®¾ç½®ç»™ Acceptorçš„å›è°ƒäº†ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æŠŠ newConnection()è®¾ç½®ç»™ acceptor</span>
  <span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">setNewConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">));</span>
</code></pre></div></div>

<p>çœ‹Acceptorå‘ç”Ÿäº†ä»€ä¹ˆäº‹ã€‚<a href="http://blog.xyecho.com/muduo-8-muduo-acceptor-class/">Acceptor class</a></p>

<p>åœ¨Acceptorçš„æ„é€ å‡½æ•°ä¸­ è°ƒç”¨äº†sockets::createNonblockingOrDie() è¿™é‡Œé¢å°±æ˜¯è°ƒç”¨::socket() è¿™æ—¶socketè¢«æˆåŠŸåˆ›å»ºäº†ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Acceptor</span><span class="o">::</span><span class="n">Acceptor</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">reuseport</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">acceptSocket_</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">createNonblockingOrDie</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">.</span><span class="n">family</span><span class="p">())),</span>
    <span class="n">acceptChannel_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">()),</span>
    <span class="n">listenning_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">idleFd_</span><span class="p">(</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">))</span> <span class="c1">//æ‰“å¼€ä¸€ä¸ªåšäº†ç©ºé—²çš„fd</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">idleFd_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">setReuseAddr</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">setReusePort</span><span class="p">(</span><span class="n">reuseport</span><span class="p">);</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">bindAddress</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">acceptChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="å½“tcpserver-çš„å¯¹è±¡è°ƒç”¨startæ—¶">å½“TcpServer çš„å¯¹è±¡è°ƒç”¨start()æ—¶ã€‚</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æœåŠ¡å¼€å§‹çš„åœ°æ–¹ æ‰§è¡Œlisten()</span>
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">started_</span><span class="p">.</span><span class="n">getAndSet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// ä»€ä¹ˆæ„æ€ï¼Ÿ</span>
  <span class="p">{</span>
    <span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">threadInitCallback_</span><span class="p">);</span> <span class="c1">//æŠŠå›è°ƒå‡½æ•°ä¼ å…¥</span>

    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">listenning</span><span class="p">());</span>
    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">listen</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">acceptor_</span><span class="p">)));</span>   
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ—¶å€™TCPServerå¼€å§‹äº†listen()äº†ã€‚ è¿™ä¸ªæ—¶å€™TCPSeveråº”è¯¥ç®—æ˜¯å¯æ¥äº†ã€‚å°±ç­‰ç€accept()æ–°çš„è¿æ¥äº†ã€‚</p>

<h4 id="ä¸‹é¢è¦çŸ¥é“çš„æ˜¯muduoæ˜¯å¦‚ä½•acceptçš„å‘¢">ä¸‹é¢è¦çŸ¥é“çš„æ˜¯muduoæ˜¯å¦‚ä½•accept()çš„å‘¢ï¼Ÿ</h4>

<p>åœ¨Acceptorçš„æ„é€ å‡½æ•°ä¸­ acceptChannel_(loop, acceptSocket_.fd())ã€‚ å·²ç»æŠŠ socketçš„fdäº¤ç»™äº†channeläº†ã€‚åŒæ—¶ä¹Ÿè®¾ç½®äº†</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">acceptChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</code></pre></div></div>

<p>å½“acceptSocket_.fd()äº†è¯»äº‹ä»¶æ—¶ï¼Œå°±ä¼šå›è°ƒåˆ° Acceptor::handleRead()</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æœ‰äº†è¯»äº‹ä»¶ï¼Œå°±å›è°ƒå‡½æ•° åˆ›å»ºæ–°çš„é“¾æ¥</span>
<span class="kt">void</span> <span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">InetAddress</span> <span class="n">peerAddr</span><span class="p">;</span>
  <span class="c1">//FIXME loop until no more</span>
  <span class="kt">int</span> <span class="n">connfd</span> <span class="o">=</span> <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peerAddr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// string hostport = peerAddr.toIpPort();</span>
    <span class="c1">// LOG_TRACE &lt;&lt; "Accepts of " &lt;&lt; hostport;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newConnectionCallback_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">newConnectionCallback_</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">peerAddr</span><span class="p">);</span> <span class="c1">// å›è°ƒ</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">"in Acceptor::handleRead"</span><span class="p">;</span>
    <span class="c1">// Read the section named "The special problem of </span>
    <span class="c1">// accept()ing when you can't" in libev's doc.</span>
    <span class="c1">// By Marc Lehmann, author of libev.</span>

    <span class="c1">// è¿™æ ·åšï¼Œåªæ˜¯ä¸ºäº†ä¼˜é›…çš„æ–­å¼€å®¢æˆ·ç«¯ã€‚ä½†æœåŠ¡ç«¯çš„fdè€—å°½æ—¶ï¼Œå®¢æˆ·ç«¯çš„é“¾æ¥è¿˜æ˜¯åœ¨çš„ã€‚</span>
    <span class="c1">//</span>
    <span class="c1">// å‡†å¤‡ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œå…ˆå…³é—­è¿™ä¸ªç©ºé—²æ–‡ä»¶ï¼Œè·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„åé¢ï¼›</span>
    <span class="c1">// å†accept(2)æ‹¿åˆ°æ–°socketè¿æ¥çš„æè¿°ç¬¦ï¼›éšåç«‹åˆ»close(2)å®ƒï¼Œè¿™æ ·å°±ä¼˜é›…åœ°æ–­å¼€äº†å®¢æˆ·ç«¯è¿æ¥ï¼›</span>
    <span class="c1">// æœ€åé‡æ–°æ‰“å¼€ä¸€ä¸ªç©ºé—²æ–‡ä»¶ï¼ŒæŠŠ"å‘"å ä½ï¼Œä»¥å¤‡å†æ¬¡å‡ºç°è¿™ç§æƒ…å†µæ—¶ä½¿ç”¨ã€‚</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EMFILE</span><span class="p">)</span>  <span class="c1">// EMFILE</span>
    <span class="p">{</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span>
      <span class="n">idleFd_</span> <span class="o">=</span> <span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span>
      <span class="n">idleFd_</span> <span class="o">=</span> <span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>handleRead å›è°ƒ newConnectionCallback_() å°±æ˜¯TcpServerç±»ä¸­çš„TcpServer::newConnection().
åé¢æ˜¯å…³äºè¿æ¥æ•°è¿‡å¤šçš„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥çœ‹ <a href="http://blog.xyecho.com/muduo-8-muduo-acceptor-class/">Acceptor class</a></p>

<p>è€ŒTcpServer::newConnection()å¯¹æ–°è¿æ¥çš„å¤„ç†ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// åœ¨Acceptorä¸­ï¼Œæœ‰è¯»äº‹ä»¶è¢«è§¦å‘æ—¶ åœ¨Acceptor::handleRead()ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°åˆ›å»ºå‡ºä¸€ä¸ªæ–°é“¾æ¥</span>
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">ioLoop</span> <span class="o">=</span> <span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">getNextLoop</span><span class="p">();</span> <span class="c1">// ä»çº¿ç¨‹æ± ä¸­æ‹¿å‡ºä¸€ä¸ª EventLoop</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">"-%s#%d"</span><span class="p">,</span> <span class="n">ipPort_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">nextConnId_</span><span class="p">);</span>
  <span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">connName</span> <span class="o">=</span> <span class="n">name_</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>

  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">"TcpServer::newConnection ["</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">"] - new connection ["</span> <span class="o">&lt;&lt;</span> <span class="n">connName</span>
           <span class="o">&lt;&lt;</span> <span class="s">"] from "</span> <span class="o">&lt;&lt;</span> <span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">();</span>
  <span class="n">InetAddress</span> <span class="n">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span>
  <span class="c1">// FIXME poll with zero timeout to double confirm the new connection</span>
  <span class="c1">// FIXME use make_shared if necessary</span>
  <span class="n">TcpConnectionPtr</span> <span class="n">conn</span><span class="p">(</span><span class="k">new</span> <span class="n">TcpConnection</span><span class="p">(</span><span class="n">ioLoop</span><span class="p">,</span>
                                          <span class="n">connName</span><span class="p">,</span>
                                          <span class="n">sockfd</span><span class="p">,</span>
                                          <span class="n">localAddr</span><span class="p">,</span>
                                          <span class="n">peerAddr</span><span class="p">));</span>
  <span class="n">connections_</span><span class="p">[</span><span class="n">connName</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span>       <span class="c1">// å¤„ç†é“¾æ¥å‘è¿‡äº†çš„æ•°æ®å‡½æ•°</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span> <span class="c1">// FIXME: unsafe</span>
  <span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>newå‡ºä¸€ä¸ªæ–°TcpConnection å¯¹è±¡ ç„¶å é€šè¿‡share_ptrçš„æ–¹å¼æ”¾å…¥ ConnectionMap connections_ ä¸­</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionMap</span><span class="p">;</span>   <span class="c1">// é“¾æ¥ç®¡ç†map  &lt;åå­—ï¼ŒTcpConnectionPtr&gt; shareæŒ‡é’ˆ</span>
 <span class="n">ConnectionMap</span> <span class="n">connections_</span><span class="p">;</span>  <span class="c1">// é“¾æ¥ç®¡ç†map </span>
</code></pre></div></div>

<p>ç„¶åè®¾ç½® connçš„å„ç§å›è°ƒå‡½æ•°ã€‚</p>

<p>æœ€åæ‰§è¡ŒTcpConnection::connectEstablished æŠŠ TcpConnection ç»‘å®šåˆ° channelä¸­ hannel_-&gt;tie(shared_from_this());</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">);</span>
  <span class="n">setState</span><span class="p">(</span><span class="n">kConnected</span><span class="p">);</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">tie</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableReading</span><span class="p">();</span>

  <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åˆ°è¿™é‡Œï¼Œä¸€ä¸ªæ–°è¿æ¥çš„æ¥å—å°±å®Œæˆäº†ã€‚</p>

<p>å¼ºåˆ¶å…³é—­å’Œå»¶è¿Ÿå…³é—­</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// å¼ºåˆ¶å…³é—­</span>
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">forceClose</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// FIXME: use compare and swap</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span> <span class="o">||</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnecting</span><span class="p">);</span>
    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">forceCloseInLoop</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">()));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// å»¶è¿Ÿå¼ºåˆ¶å…³é—­æ‰ å»¶è¿Ÿå¤šå°‘ç§’ã€‚ ç”¨çš„æ˜¯å®šæ—¶å™¨runAfter</span>
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">forceCloseWithDelay</span><span class="p">(</span><span class="kt">double</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span> <span class="o">||</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnecting</span><span class="p">);</span>
    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span>
        <span class="n">seconds</span><span class="p">,</span>
        <span class="n">makeWeakCallback</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">(),</span>
                         <span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">forceClose</span><span class="p">));</span>  <span class="c1">// not forceCloseInLoop to avoid race condition</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// åœ¨è‡ªå·±æ‰€å±çš„EventLoopå…³é—­ é“¾æ¥</span>
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">forceCloseInLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span> <span class="o">||</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// as if we received 0 byte in handleRead();</span>
    <span class="n">handleClose</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åä¹Ÿæ˜¯è°ƒç”¨åˆ°handleClose()ã€‚åé¢çš„é€»è¾‘å°±ä¸€æ ·äº†ã€‚</p>

<p>TcpConnection::shutdown() åªæ˜¯å…³é—­äº†å®šçš„åŠ¨ä½œã€‚ç”¨çš„æ˜¯Socketçš„ shutdown()ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// shutdownå’ŒforceCloseåŒºåˆ« ?</span>
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdown</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// FIXME: use compare and swap</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnecting</span><span class="p">);</span>
    <span class="c1">// FIXME: shared_from_this()?  </span>
    <span class="c1">//è¿™é‡Œæ²¡æœ‰ç”¨åˆ°share_from_this ? åƒforceClose éƒ½æ˜¯ç”¨åˆ°share_from_thisçš„</span>
    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// å…³é—­é“¾æ¥ï¼Œ è¿™é‡Œåªå…³é—­å†™çš„åŠ¨ä½œ ç”¨çš„æ˜¯  ::shutdown()</span>
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span> <span class="c1">// å¦‚æœå½“å‰æ²¡æœ‰å‘é€æ•°æ®</span>
  <span class="p">{</span>
    <span class="c1">// we are not writing</span>
    <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">shutdownWrite</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<hr />
<p>-â€“ ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ï¼šä½¿ç”¨muduo C++ ç½‘ç»œåº“ã€‹ é™ˆç¡•. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾. Kindle ç‰ˆæœ¬.</p>

:ET