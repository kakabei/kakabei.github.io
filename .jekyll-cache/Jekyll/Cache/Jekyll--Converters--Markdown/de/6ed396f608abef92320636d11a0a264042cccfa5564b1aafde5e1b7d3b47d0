I"õ<p>TGT æ˜¯ä¸€ç§åœ¨ç”¨æˆ·æ€ä¸‹çš„ SCSI target æ¡†æ¶ã€‚ ç”¨äº iSCSI å’Œ iSER ä¼ è¾“åè®®ã€‚ æ”¯æŒå¤šç§æ–¹å¼è®¿é—®è®¾å¤‡å—ã€‚</p>

<p>æ¡†æ¶åŒ…å«äº†ç”¨æˆ·æ€ä¸‹çš„ deamon å’Œå·¥å…·ã€‚</p>

<p>æºç åœ¨ï¼š<a href="https://github.com/fujita/tgt">https://github.com/fujita/tgt</a></p>

<p>å½“å‰ï¼ŒTGT æ”¯æŒçš„ä¼ è¾“åè®®æœ‰ï¼š</p>

<ul>
  <li>ä»¥å¤ªç½‘ç½‘å¡çš„ iSCSI  target è½¯ä»¶é©±åŠ¨ç¨‹åº</li>
  <li>Infiniband å’Œ RDMA ç½‘å¡çš„ iSER target è½¯ä»¶é©±åŠ¨ç¨‹åº</li>
</ul>

<p>æ”¯æŒå¯ä»¥è®¿é—®çš„æœ¬åœ°å­˜å‚¨æœ‰ï¼š</p>

<ul>
  <li>aio, the asynchronous I/O interface also known as libaio.</li>
  <li>rdwr, smc and mmc, synchronous I/O based on the pread() and pwrite() system calls.</li>
  <li>null, discards all data and reads zeroes.</li>
  <li>ssc, SCSI tape support.</li>
  <li>sg and bsg, SCSI pass-through.</li>
  <li>glfs, the GlusterFS network filesystem.</li>
  <li>rbd, Cephâ€™s distributed-storage RADOS Block Device.</li>
  <li>sheepdog, a distributed object storage system.</li>
</ul>

<p>å·¥ä½œä¸­ä¹‹æ‰€ä»¥ç”¨åˆ° TGTï¼Œ å°±æ˜¯ä¸ºäº†è®¿é—® ceph çš„å—è®¾å¤‡ã€‚</p>

<h1 id="iscsi-åè®®">iSCSI åè®®</h1>

<p>SCSI (Small Computer System Interface,å°å‹è®¡ç®—æœºç³»ç»Ÿæ¥å£) ç”¨äºä¸»æœºä¸å¤–éƒ¨è®¾å¤‡ä¹‹é—´çš„è¿æ¥ã€‚SCSI åè®®æ˜¯ä¸»æœºä¸ç£ç›˜é€šä¿¡çš„åŸºæœ¬åè®®ã€‚å®ƒç”±SCSI æ§åˆ¶å™¨è¿›è¡Œæ•°æ®æ“ä½œ,SCSIæ§åˆ¶å™¨ç›¸å½“äºä¸€ä¸ªå°å‹CPU,æœ‰è‡ªå·±çš„å‘½ä»¤é›†å’Œç¼“å­˜ ã€‚</p>

<p>è€Œ iSCSI åè®®å°±æ˜¯è®© SCSI å¯ä»¥åœ¨äº’è”ç½‘ä¸Šä¼ è¾“ã€‚</p>

<h1 id="tgt-çš„å®‰è£…">TGT çš„å®‰è£…</h1>

<p>ä¸¤ç§æ–¹å¼ï¼š</p>

<p>1ã€æºç ç¼–è¯‘</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/fujita/tgt.git

<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> ceph-common librados-dev  librbd-dev   manpages-zh  xsltproc   docbook-xsl

<span class="nb">cd </span>tgt

make

make <span class="nb">install</span>
</code></pre></div></div>
<p>å®‰è£…åæ–‡ä»¶çš„ç›®å½•</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 755 /usr/sbin
<span class="nb">install</span> <span class="nt">-m</span> 755 tgtd tgtadm tgtimg /usr/sbin
<span class="nb">install</span> <span class="nt">-d</span> <span class="nt">-m</span> 755 /usr/lib/tgt/backing-store
<span class="nb">install</span> <span class="nt">-m</span> 755 bs_rbd.so /usr/lib/tgt/backing-store
</code></pre></div></div>

<p>2ã€ apt ç›´æ¥å®‰è£…</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>tgt-rbd
</code></pre></div></div>
<h1 id="tgt-çš„ç¨‹åºæ¡†æ¶">TGT çš„ç¨‹åºæ¡†æ¶</h1>

<p>TGT çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯å®ƒå¯ä»¥åœ¨ç”¨æˆ·æ€ä¸‹åˆ›å»ºç®¡ç†å—è®¾å¤‡ã€‚è¿™æ ·ä¸ç”¨æ¯ä¸€æ¬¡ä»£ç çš„æ›´æ–°éƒ½è¦é‡æ–°ç¼–è¯‘å†…æ ¸æ¨¡å—ã€‚</p>

<p>tgtamd æ˜¯ TGTçš„ç®¡ç†å·¥å…·ï¼Œå®ƒæ˜¯é€šè¿‡ unix socket å’Œ tgt daemon é€šä¿¡ã€‚</p>

<p>tgt daemon ï¼ˆè¿›ç¨‹å tgtdï¼‰è´Ÿè´£å’Œå†…æ ¸æ€ä¸‹çš„ tgt core æ¨¡å—é€šä¿¡ã€‚</p>

<p>tgt core é€šè¿‡ target é©±åŠ¨ç¨‹åºå’Œ ceph å—è®¾å¤‡é€šä¿¡ã€‚</p>

<p><img src="/assets/dfs/tgt-2023-04-24-19-16-06.png" alt="" /></p>

<p>è¦å’Œ ceph å—è®¾å¤‡é€šä¿¡ï¼Œç³»ç»Ÿè¦å®‰è£… ceph çš„ libradosã€‚</p>

<p>å³å®‰è£…æ—¶è¦å…ˆ <code class="language-plaintext highlighter-rouge">apt install -y ceph-common librados-dev  librbd-dev</code></p>

<p>å’Œ ceph é›†ç¾¤é€šä¿¡çš„æ˜¯ ceph libradosã€‚</p>

<p>ceph é›†ç¾¤è¦å®‰å…¨è®¤è¯ï¼Œæ‰€ä»¥ç›¸å…³çš„é…ç½®æ–‡ä»¶è¦æ‹·è´åˆ° <code class="language-plaintext highlighter-rouge">/etc/ceph/</code> ä¸‹ã€‚</p>

<p>å®‰è£…å®Œ tgt åã€‚å¯ä»¥ä½¿ç”¨ rbd å‘½ä»¤ç®¡ç†  ceph é›†ç¾¤ä¸Šçš„å—è®¾å¤‡ã€‚rbd æ˜¯é€šè¿‡ tgtd å’Œ ceph é›†ç¾¤äº¤äº’çš„ã€‚</p>

<h1 id="tgt-å¸¸ç”¨çš„å‘½ä»¤">TGT å¸¸ç”¨çš„å‘½ä»¤</h1>

<p>1ã€åˆ›å»º target</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tgtadm <span class="nt">--lld</span> iscsi <span class="nt">--mode</span> target <span class="nt">--op</span> new <span class="nt">--tid</span> 1 <span class="nt">--targetname</span> iqn.2009-02.com.example:for.all
</code></pre></div></div>
<p>targetname æ˜¯æˆ‘ä»¬è¦åˆ›å»ºçš„ target çš„åå­—ï¼Œå…¶é‡‡ç”¨IQN å‘½åæ ¼å¼ï¼šiqn.å¹´-æœˆ.åå‘åŸŸå:ä»»ä½•å”¯ä¸€çš„åå­—</p>

<p>2ã€åˆ›å»º lun</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tgtadm <span class="nt">--lld</span> iscsi <span class="nt">--mode</span> logicalunit <span class="nt">--op</span> new <span class="nt">--tid</span> <span class="nt">--lun</span> 1 <span class="nt">--backing-store</span> /mnt/disk.img
</code></pre></div></div>

<p>backing-store ä»£è¡¨æˆ‘ä»¬åç«¯å­˜å‚¨çš„æ–‡ä»¶åï¼Œæˆ‘ä»¬ä¸æ˜¯çœŸæ­£çš„ç£ç›˜ï¼›è¦æ¨¡æ‹Ÿç£ç›˜çš„æ•°æ®ä¿å­˜åŠŸèƒ½ï¼Œå¯ä»¥å°†æ•°æ®ä¿æŒåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œã€‚</p>

<p>3ã€è®¾ç½®è®¿é—®æƒé™ï¼ˆæ­¤å¤„æˆ‘ä»¬å…è®¸æ‰€æœ‰IPè®¿é—®ï¼‰</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tgtadm <span class="nt">--lld</span> iscsi <span class="nt">--mode</span> target <span class="nt">--op</span> <span class="nb">bind</span> <span class="nt">--tid</span> 1 <span class="nt">-I</span> ALL
</code></pre></div></div>

<p>iSCSI åè®®å¯ä»¥è®¾ç½®è®¿é—®æƒé™çš„ï¼Œå¯ä»¥é€šè¿‡ IP æ¥é™åˆ¶è®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç”¨æˆ·å/å¯†ç æ–¹å¼é™åˆ¶è®¿é—®ã€‚</p>

<p>4ã€æŸ¥çœ‹åˆ›å»ºçš„ target å’Œ lun</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tgtadm <span class="nt">--lld</span> iscsi <span class="nt">--mode</span> target <span class="nt">--op</span> show
</code></pre></div></div>

<p>æ›´å¤šçš„å‘½ä»¤å¯ä»¥ç”¨ <code class="language-plaintext highlighter-rouge">man tgtadm</code> æŸ¥è¯¢ã€‚</p>

<hr />

<p>1ã€<a href="https://houmin.cc/posts/454a90d3/">RDMA æ¶æ„ä¸å®è·µ</a></p>

<p>2ã€<a href="https://zhuanlan.zhihu.com/p/336499148">InfinibandæŠ€æœ¯ç®€ä»‹</a></p>

<p>3ã€<a href="https://zhuanlan.zhihu.com/p/137047153">TGTå­¦ä¹ æ€»ç»“</a></p>

<p>4ã€<a href="https://blog.csdn.net/Morry_Chan/article/details/100891020">tgtç½‘å…³æºç è§£è¯»</a></p>

<p>5ã€<a href="https://blog.csdn.net/qqqqqq999999/article/details/72547970">linux iscsiç½‘ç»œçš„ä¸‰ç§å·¥å…·tgt iscsi_tgt targetcli</a></p>
:ET