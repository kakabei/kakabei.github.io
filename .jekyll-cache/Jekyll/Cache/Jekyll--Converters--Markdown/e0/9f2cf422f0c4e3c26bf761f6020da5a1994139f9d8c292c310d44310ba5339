I"1<h1 id="ä¸€reactor-æ¨¡å¼">ä¸€ã€reactor æ¨¡å¼</h1>

<p>æ•´ä¸ª libevent æœ¬èº«å°±æ˜¯ä¸€ä¸ª reactor(ååº”å †)ï¼Œæ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚libevent åº•å±‚æ‰€è¿ç”¨çš„å°±æ˜¯ epoll è¿™æ ·çš„ä¸€äº›æ¨¡å‹ã€‚</p>

<p>åº”ç”¨ç¨‹åºä¸€èˆ¬éƒ½è¦åœ¨ reactor æ³¨å†Œå›è°ƒå‡½æ•°ã€‚å½“äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚è¿™äº›äº‹ä»¶å¯èƒ½æ˜¯<strong>I/Oè¯»å†™</strong>ï¼Œ <strong>å®šæ—¶å™¨</strong>å’Œ<strong>ä¿¡å·</strong>ã€‚</p>

<p>reactor æ¨¡å‹å¿…å¤‡çš„å‡ ä¸ªç»„ä»¶ï¼šäº‹ä»¶æºã€reactor æ¡†æ¶ã€å¤šè·¯åˆ©ç”¨æœºåˆ¶å’Œäº‹ä»¶å¤„ç†å‡½æ•°ã€‚</p>

<p><strong>äº‹ä»¶æºï¼š</strong></p>

<p>Linuxä¸Šæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œ winä¸‹çš„socket æˆ– handle.</p>

<p><strong>event demultipexer (äº‹ä»¶å¤šè·¯åˆ†å‘æœºåˆ¶)ï¼š</strong></p>

<p>linuxä¸‹å¦‚ï¼šepollã€ selectã€kqueueã€devpoll</p>

<p>å½“æœ‰äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œ <code class="language-plaintext highlighter-rouge">event demultiplexer</code> ä¼šå‘å‡ºé€šçŸ¥ã€‚è¿™æ—¶ç›¸å…³çš„äº‹ä»¶å°±æˆäº†å°±ç»ªçŠ¶æ€ã€‚libevent ä¼šåœ¨éé˜»å¡çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†ã€‚</p>

<p>libevent ç”¨ eventtop å¯¹ select epoll poll ç­‰è¿›è¡Œäº†å°é—­ï¼Œå½¢æˆç»Ÿä¸€çš„æ¥å£ã€‚</p>

<p><strong>reactor ååº”å™¨ï¼š</strong></p>

<p>reactor æ˜¯äº‹ä»¶ç®¡ç†æ¥å£ã€‚å†…éƒ¨ä½¿ç”¨ event demultiplexer æ³¨å†Œã€æ³¨é”€äº‹ä»¶ï¼›å¹¶è¿è¡Œäº‹ä»¶å¾ªç¯ï¼Œ
å½“æœ‰äº‹ä»¶è¿›å…¥â€œå°±ç»ªâ€çŠ¶æ€æ—¶ï¼Œè°ƒç”¨æ³¨å†Œäº‹ä»¶çš„å›è°ƒå‡½æ•°å¤„ç†äº‹ä»¶ã€‚å¯¹åº”åˆ° libevent ä¸­ï¼Œå°±æ˜¯ event_base ç»“æ„ä½“ã€‚</p>

<p><strong>äº‹ä»¶å¤„ç†æµç¨‹å›¾ï¼š</strong></p>

<p>1ï¼‰é¦–å…ˆåº”ç”¨ç¨‹åºå‡†å¤‡å¹¶åˆå§‹åŒ– eventï¼Œè®¾ç½®å¥½äº‹ä»¶ç±»å‹å’Œå›è°ƒå‡½æ•°ï¼›</p>

<p>2ï¼‰å‘ libevent æ·»åŠ è¯¥äº‹ä»¶ eventã€‚å¯¹äºå®šæ—¶äº‹ä»¶ï¼Œ libevent ä½¿ç”¨ä¸€ä¸ªå°æ ¹å †ç®¡ç†ï¼Œ key ä¸ºè¶…
æ—¶æ—¶é—´ï¼›å¯¹äº Signal å’Œ I/O äº‹ä»¶ï¼Œ libevent å°†å…¶æ”¾å…¥åˆ°ç­‰å¾…é“¾è¡¨ï¼ˆ wait listï¼‰ä¸­ï¼Œè¿™æ˜¯ä¸€
ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼›</p>

<p>3ï¼‰ ç¨‹åºè°ƒç”¨ <code class="language-plaintext highlighter-rouge">event_base_dispatch()</code> ç³»åˆ—å‡½æ•°è¿›å…¥æ— é™å¾ªç¯ï¼Œç­‰å¾…äº‹ä»¶ï¼Œä»¥ <code class="language-plaintext highlighter-rouge">select()</code> å‡½æ•°ä¸ºä¾‹ï¼›
æ¯æ¬¡å¾ªç¯å‰ libevent ä¼šæ£€æŸ¥å®šæ—¶äº‹ä»¶çš„æœ€å°è¶…æ—¶æ—¶é—´ tvï¼Œæ ¹æ® tv è®¾ç½® <code class="language-plaintext highlighter-rouge">select()</code> çš„æœ€å¤§ç­‰
å¾…æ—¶é—´ï¼Œä»¥ä¾¿äºåé¢åŠæ—¶å¤„ç†è¶…æ—¶äº‹ä»¶ï¼›å½“ <code class="language-plaintext highlighter-rouge">select()</code> è¿”å›åï¼Œé¦–å…ˆæ£€æŸ¥è¶…æ—¶äº‹ä»¶ï¼Œç„¶åæ£€æŸ¥ I/O äº‹ä»¶ï¼›</p>

<p><img src="/assets/network/libevent_event_next.png" alt="" /></p>

<h1 id="äºŒæºç æ–‡ä»¶ç»„ç»‡ç»“æ„">äºŒã€æºç æ–‡ä»¶ç»„ç»‡ç»“æ„</h1>

<p>ä¸»è¦åˆ†ä¸ºå¤´æ–‡ä»¶ã€å†…éƒ¨ä½¿ç”¨çš„å¤´æ–‡ä»¶ã€è¾…åŠ©åŠŸèƒ½å‡½æ•°ã€æ—¥å¿—ã€libeventæ¡†æ¶ã€å¯¹ç³»ç»Ÿ I/O å¤šè·¯å¤ç”¨æœºåˆ¶çš„å°è£…
ä¿¡å·ç®¡ç†ã€å®šæ—¶äº‹ä»¶ç®¡ç†ã€ç¼“å†²åŒºç®¡ç†ã€åŸºæœ¬æ•°æ®å’ŒåŸºäºlibeventçš„ä¸¤ä¸ªå®ç”¨åº“çš„å‘ä¸ªéƒ¨åˆ†ã€‚</p>

<p><strong>å¤´æ–‡ä»¶</strong></p>

<p>event.hï¼šäº‹ä»¶å®å®šä¹‰ã€æ¥å£å‡½æ•°å£°æ˜ï¼Œä¸»è¦ç»“æ„ä½“eventçš„å£°æ˜ï¼›</p>

<p>xxx-internal.hï¼šå†…éƒ¨æ•°æ®ç»“æ„å’Œå‡½æ•°ï¼Œå¯¹å¤–ä¸å¯è§ï¼Œä»¥è¾¾åˆ°ä¿¡æ¯éšè—çš„ç›®çš„ï¼›</p>

<p><strong>libeventæ¡†æ¶</strong></p>

<p>event.cï¼ševentæ•´ä½“æ¡†æ¶çš„ä»£ç å®ç°ï¼›</p>

<p>å¯¹ç³»ç»ŸI/Oå¤šè·¯å¤ç”¨æœºåˆ¶çš„å°è£…</p>

<ul>
  <li>epoll.cï¼šå¯¹epollçš„å°è£…ï¼›</li>
  <li>select.cï¼šå¯¹selectçš„å°è£…ï¼›</li>
  <li>devpoll.cï¼šå¯¹dev/pollçš„å°è£…;</li>
  <li>kqueue.cï¼šå¯¹kqueueçš„å°è£…ï¼›</li>
</ul>

<p><strong>å®šæ—¶äº‹ä»¶ç®¡ç†</strong></p>

<p>min-heap.hï¼šå…¶å®å°±æ˜¯ä¸€ä¸ªä»¥æ—¶é—´ä½œä¸ºkeyçš„å°æ ¹å †ç»“æ„ï¼›</p>

<p><strong>ä¿¡å·ç®¡ç†</strong></p>

<p>signal.cï¼šå¯¹ä¿¡å·äº‹ä»¶çš„å¤„ç†ï¼›</p>

<p><strong>è¾…åŠ©åŠŸèƒ½å‡½æ•°</strong></p>

<p>evutil.h å’Œevutil.cï¼šä¸€äº›è¾…åŠ©åŠŸèƒ½å‡½æ•°ï¼ŒåŒ…æ‹¬åˆ›å»ºsocket pairå’Œä¸€äº›æ—¶é—´æ“ä½œå‡½æ•°ï¼šåŠ ã€å‡å’Œæ¯”è¾ƒç­‰ã€‚</p>

<p><strong>æ—¥å¿—</strong></p>

<p>log.hå’Œlog.cï¼šlogæ—¥å¿—å‡½æ•°</p>

<p><strong>ç¼“å†²åŒºç®¡ç†</strong></p>

<p>evbuffer.c å’Œ buffer.cï¼šlibevent å¯¹ç¼“å†²åŒºçš„å°è£…ï¼›</p>

<p><strong>åŸºæœ¬æ•°æ®ç»“æ„</strong></p>

<p>compat\sys ä¸‹çš„ä¸¤ä¸ªæºæ–‡ä»¶ï¼šqueue.h æ˜¯ libevent åŸºæœ¬æ•°æ®ç»“æ„çš„å®ç°ï¼ŒåŒ…æ‹¬é“¾è¡¨ï¼ŒåŒå‘é“¾è¡¨ï¼Œé˜Ÿåˆ—ç­‰ï¼›
_libevent_time.hï¼šä¸€äº›ç”¨äºæ—¶é—´æ“ä½œçš„ç»“æ„ä½“å®šä¹‰ã€å‡½æ•°å’Œå®å®šä¹‰ï¼›</p>

<p><strong>å®ç”¨ç½‘ç»œåº“</strong></p>

<p>httpå’Œevdnsï¼šæ˜¯åŸºäºlibeventå®ç°çš„httpæœåŠ¡å™¨å’Œå¼‚æ­¥dnsæŸ¥è¯¢åº“</p>

<h1 id="ä¸‰äº‹ä»¶-event">ä¸‰ã€äº‹ä»¶ event</h1>

<p>ä¸»è¦çš„ç»“æ„ä½“ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">event_base</span> <span class="c1">// eventæœ€ä¸»è¦çš„ç»“æ„ï¼Œ</span>
<span class="k">struct</span> <span class="n">eventop</span>    <span class="c1">// å®šä¹‰backendç»“æ„ï¼Œ é€šè¿‡å®ƒå®šä¹‰å„ä¸ªæ¨¡å‹ï¼Œ</span>
</code></pre></div></div>

<ul>
  <li>ev_eventsï¼š eventå…³æ³¨çš„äº‹ä»¶ç±»å‹ï¼Œå®ƒå¯ä»¥æ˜¯ä»¥ä¸‹3ç§ç±»å‹ï¼š</li>
  <li>I/Oäº‹ä»¶ï¼š  EV_WRITEå’ŒEV_READ</li>
  <li>å®šæ—¶äº‹ä»¶ï¼š EV_TIMEOUT</li>
  <li>ä¿¡å·ï¼š     EV_SIGNAL</li>
  <li>è¾…åŠ©é€‰é¡¹ï¼š EV_PERSISTï¼Œè¡¨æ˜æ˜¯ä¸€ä¸ªæ°¸ä¹…äº‹ä»¶</li>
</ul>

<p>ev_nextï¼Œ ev_active_next å’Œ ev_signal_next éƒ½æ˜¯åŒå‘é“¾è¡¨èŠ‚ç‚¹æŒ‡é’ˆã€‚</p>

<p>I/Oå’ŒSignaläº‹ä»¶ä½¿ç”¨äº†åŒå‘é“¾è¡¨ã€‚</p>

<p>å®šæ—¶äº‹ä»¶ ä½¿ç”¨äº†å°æ ¹å † min_heap_idx.</p>

<p>ev_next æ˜¯è¯¥I/Oäº‹ä»¶åœ¨é“¾è¡¨ä¸­çš„ä½ç½®ï¼Œè¡¨ç¤ºæ˜¯â€œå·²æ³¨å†Œäº‹ä»¶é“¾è¡¨â€ã€‚
ev_signal_next signaläº‹ä»¶åœ¨signaläº‹ä»¶é“¾è¡¨ä¸­çš„ä½ç½®ã€‚
ev_active_next libeventå°†æ‰€æœ‰çš„æ¿€æ´»äº‹ä»¶æ”¾å…¥åˆ°é“¾è¡¨active listä¸­ï¼Œç„¶åéå† active listæ‰§è¡Œè°ƒåº¦ï¼Œev_active_next å°±æŒ‡æ˜äº†event åœ¨ active listä¸­çš„ä½ç½®ã€‚</p>

<p><strong><em>libevent å¯¹ event çš„ç®¡ç†</em></strong></p>

<p><img src="/assets/network/libevent_event_managemant.png" alt="" /></p>

<p>äº‹ä»¶è®¾ç½®çš„æ¥å£å‡½æ•°</p>

<p>libevent æä¾›äº†å‡½æ•°ï¼ševent_set(), event_base_set(), event_priority_set()ã€‚</p>

<p>è®¾ç½®äº‹ä»¶ å¦‚ï¼šI/Oäº‹ä»¶ã€ æ—¶é—´äº‹ä»¶ã€ä¿¡å·äº‹ä»¶:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">event_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">short</span> <span class="n">events</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</code></pre></div></div>

<p>è®¾ç½® event ev å°†è¦æ³¨å†Œåˆ°çš„ event_baseï¼›</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">event_base_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">)</span>
</code></pre></div></div>

<p>è®¾ç½®event evçš„ä¼˜å…ˆçº§:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">event_priority_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="å››äº‹ä»¶å¤„ç†æ¡†æ¶">å››ã€äº‹ä»¶å¤„ç†æ¡†æ¶</h1>

<p>äº‹ä»¶å¤„ç†éƒ½æ˜¯å›´ç»•ç€ event_baseã€‚</p>

<p>åˆå§‹åŒ–ä¸€ä¸ª event_baseã€‚ æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† event_base_new_with_configã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span> <span class="n">event_init</span><span class="p">()</span>
</code></pre></div></div>

<p>ä¹Ÿæ˜¯ åˆå§‹åŒ–ä¸€ä¸ª event_baseã€‚ä¸åŒçš„æ˜¯ å…ˆåˆ›å»ºäº†ä¸€ä¸ªstruct event_configã€‚ è¿™ä¸ªä¸œè¥¿æ˜¯å¹²ä»€ä¹ˆç”¨çš„è¿˜ä¸æ¸…æ¥šã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span> <span class="n">event_base_new</span><span class="p">()</span>
</code></pre></div></div>

<p>å†…éƒ¨ä¸»è¦è°ƒç”¨äº† event_base_new_with_configã€‚()</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">event_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div>

<p>å†…éƒ¨ä¸»è¦è°ƒç”¨äº† event_del_internal()</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">event_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">);</span>
</code></pre></div></div>
<p>å‡½æ•°å°†åˆ é™¤äº‹ä»¶ evï¼Œå¯¹äº I/O äº‹ä»¶ï¼Œä» I/O çš„ demultiplexer ä¸Šå°†äº‹ä»¶æ³¨é”€ï¼›å¯¹äº Signal
äº‹ä»¶ï¼Œå°†ä» Signal äº‹ä»¶é“¾è¡¨ä¸­åˆ é™¤ï¼›å¯¹äºå®šæ—¶äº‹ä»¶ï¼Œå°†ä»å †ä¸Šåˆ é™¤ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">event_base_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loops</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">event_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="kt">short</span> <span class="n">events</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">event_process_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">);</span>
</code></pre></div></div>

<p>event_base_loopï¼š ç­‰å¾…äº‹ä»¶ï¼Œåˆ†å‘äº‹ä»¶ã€‚</p>

<p>event_activeï¼šå°±ç»ªäº‹ä»¶ã€‚</p>

<p>event_process_activeï¼šã€€å¤„ç†å°±ç»ªäº‹ä»¶ã€‚</p>

<h1 id="äº”äº‹ä»¶ä¸»å¾ªç¯">äº”ã€äº‹ä»¶ä¸»å¾ªç¯</h1>

<p>struct evsig_info // è¿™ä¸ªåˆæ˜¯å¹²å—çš„ï¼Ÿ</p>

<p><strong>I/Oå’ŒTimeräº‹ä»¶çš„ç»Ÿä¸€</strong></p>

<p>libeventå°†Timerå’ŒSignaläº‹ä»¶éƒ½ç»Ÿä¸€åˆ°äº†ç³»ç»Ÿçš„I/O çš„demultiplexæœºåˆ¶ä¸­äº†ï¼Œ</p>

<p>å †æ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œå‘å †ä¸­æ’å…¥ã€åˆ é™¤å…ƒç´ æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(lgN)ã€‚è€Œè·å–æœ€å°keyå€¼ï¼ˆå°æ ¹å †ï¼‰çš„å¤æ‚åº¦ä¸ºO(1)ã€‚</p>

<p><strong>I/Oå’ŒSignaläº‹ä»¶çš„ç»Ÿä¸€</strong></p>

<p>å¦‚æœå½“Signalå‘ç”Ÿæ—¶ï¼Œå¹¶ä¸ç«‹å³è°ƒç”¨eventçš„callbackå‡½æ•°å¤„ç†ä¿¡å·ï¼Œè€Œæ˜¯è®¾æ³•é€šçŸ¥ç³»ç»Ÿçš„I/Oæœºåˆ¶ï¼Œè®©å…¶è¿”å›ï¼Œç„¶åå†ç»Ÿä¸€å’ŒI/Oäº‹ä»¶ä»¥åŠTimerä¸€èµ·å¤„ç†ã€‚</p>

<h1 id="å…­é›†æˆä¿¡å·å¤„ç†">å…­ã€é›†æˆä¿¡å·å¤„ç†</h1>

<p>singalå’ŒI/Oçš„äº‹ä»¶ç»Ÿä¸€æ˜¯é€šè¿‡ socket pairçš„æ–¹å¼å®ç°ã€‚ï¼ˆè¿™ä¸ªæ–¹å¼æœ‰ç‚¹åƒæ˜¯ç®¡é“ï¼‰</p>

<h1 id="ä¸ƒioå¤šè·¯å¤ç”¨æŠ€æœ¯">ä¸ƒã€I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯</h1>

<p>libeventæ ¹æ®ç³»ç»Ÿé…ç½®å’Œç¼–è¯‘é€‰é¡¹å†³å®šä½¿ç”¨å“ªä¸€ç§I/O demultiplexæœºåˆ¶ï¼Œè€Œä¸æ”¯æŒåœ¨è¿è¡Œé˜¶æ®µæ ¹æ®é…ç½®å†æ¬¡é€‰æ‹©ã€‚</p>

<h1 id="åä¸€-æ—¶é—´ç®¡ç†">åä¸€ ã€æ—¶é—´ç®¡ç†</h1>

<p>Libevent æœ¬èº«ä¸æ˜¯å¤šçº¿ç¨‹å®‰å…¨çš„
libevent åº“çš„å…¶ä»–ç»„ä»¶æä¾›å…¶ä»–åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¼“å†²çš„äº‹ä»¶ç³»ç»Ÿï¼ˆç”¨äºç¼“å†²å‘é€åˆ°å®¢æˆ·ç«¯/ä»å®¢æˆ·ç«¯æ¥æ”¶çš„æ•°æ®ï¼‰ä»¥åŠ HTTPã€DNS å’Œ RPC ç³»ç»Ÿçš„æ ¸å¿ƒå®ç°ã€‚</p>

<p>å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ libev</p>

<hr />

<p>å‚è€ƒï¼š<a href="http://pan.baidu.com/s/1hssU5KC"><strong>libeventæºç æ·±åº¦å‰–æ.pdf</strong></a></p>

:ET