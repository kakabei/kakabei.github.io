I"×)<h1 id="weak_ptr-æ¦‚å¿µ">weak_ptr æ¦‚å¿µ</h1>

<p><code class="language-plaintext highlighter-rouge">weak_ptr</code>  ä»åå­—ä¸Šçœ‹æ˜¯å…·â€œå¼±â€å…±äº«çš„ç‰¹ç‚¹ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç®¡ç†çš„å¯¹è±¡ã€‚</p>

<p>1ã€ä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> æ‰€æŒ‡ï¼Œå¼•ç”¨è®¡æ•°ä¼šå¢åŠ ã€‚</p>

<p>2ã€<code class="language-plaintext highlighter-rouge">weak_ptr</code> æŒ‡å‘ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> æ‰€æŒ‡å‘çš„å¯¹è±¡æ—¶ï¼Œ<strong>è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸ä¼šå¢åŠ </strong> ã€‚è¿™ä¸ªæ˜¯ <code class="language-plaintext highlighter-rouge">weak_ptr</code> æœ€é‡è¦çš„åŒºåˆ«ã€‚</p>

<p>3ã€å½“ <code class="language-plaintext highlighter-rouge">shared_ptr</code> å…¨éƒ¨è¢«é‡Šæ”¾æ—¶ï¼Œå¯¹åº”çš„å¯¹è±¡ä¼šè¢«é‡Šæ”¾ã€‚å³ä¾¿è¿˜æœ‰ <code class="language-plaintext highlighter-rouge">weak_ptr</code> æŒ‡å‘è¯¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å†…å­˜ä»ç„¶ä¼šè¢«é‡Šæ”¾ã€‚</p>

<p>4ã€ä½¿ç”¨æ—¶éœ€æ·»åŠ å¤´æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">&lt;memory&gt;</code>ã€‚</p>

<h1 id="weak_ptr--åŸºæœ¬ä½¿ç”¨">weak_ptr  åŸºæœ¬ä½¿ç”¨</h1>

<p><code class="language-plaintext highlighter-rouge">weak_ptr</code>  ä¸ç”¨ç›´æ¥çš„æŒ‡åˆ°æ™®é€šçš„æŒ‡é’ˆä¸Šï¼Œè€Œè¦é€šè¿‡ <code class="language-plaintext highlighter-rouge">shared_ptr</code> ç®¡ç†çš„å¯¹è±¡ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  
<span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">);</span> <span class="c1">// ä¸€ä¸ªshared_ptrå¯¹è±¡ </span>

<span class="n">weak_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">wptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="c1">//ç”¨ ptr åˆå§‹åŒ– wptrï¼Œwptr å¼±å…±äº« ptrã€‚</span>

<span class="c1">// wptr åªæ˜¯æŒ‡å‘ ptr æ‰€æŒ‡çš„å¯¹è±¡ï¼Œptr çš„å¼•ç”¨è®¡æ•°æ²¡æœ‰æ”¹å˜ã€‚</span>
</code></pre></div></div>

<h1 id="lock-å‡½æ•°">lock å‡½æ•°</h1>

<p><code class="language-plaintext highlighter-rouge">lock</code> å‡½æ•°ç”¨åˆ°æ£€æµ‹ <code class="language-plaintext highlighter-rouge">weak_ptr</code> æ‰€æŒ‡çš„å¯¹è±¡æ˜¯å¦ä»ç„¶å­˜åœ¨ã€‚ å¦‚æœ <code class="language-plaintext highlighter-rouge">weak_ptr</code> æ‰€æŒ‡çš„ <code class="language-plaintext highlighter-rouge">shared_prt</code> å¼•ç”¨è®¡æ•°ä¸º0ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„ <code class="language-plaintext highlighter-rouge">shared_ptr</code>ï¼Œå¦åˆ™ï¼Œè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">shared_ptr</code> å¯¹è±¡ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Boss"</span><span class="p">);</span> 

<span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">wptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> 

<span class="k">if</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">np</span> <span class="o">=</span> <span class="n">wptr</span><span class="p">.</span><span class="n">lock</span><span class="p">()){</span> <span class="c1">// æ˜¯å¦ä¸ºç©º</span>

	<span class="c1">// todo </span>
<span class="p">}</span><span class="n">elses</span><span class="p">{</span>
    <span class="c1">// todo </span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä½¿ç”¨ std::weak_ptr æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">;</span> <span class="c1">// å‰ç½®å£°æ˜</span>

<span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">A</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"A constructor"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"A destructor"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">b_ptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">B</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">B</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"B constructor"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
    <span class="o">~</span><span class="n">B</span><span class="p">()</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"B destructor"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a_ptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="n">a</span><span class="o">-&gt;</span><span class="n">b_ptr</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">b</span><span class="o">-&gt;</span><span class="n">a_ptr</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>

    <span class="c1">// æ­¤æ—¶ a å’Œ b çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 1</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"a use_count: "</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// è¾“å‡ºï¼š1</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b use_count: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// è¾“å‡ºï¼š1</span>

    <span class="n">a</span><span class="o">-&gt;</span><span class="n">b_ptr</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">a_ptr</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span> <span class="c1">// ä½¿ç”¨ lock() è·å–æŒ‡å‘ A çš„ shared_ptr æŒ‡é’ˆ</span>

    <span class="c1">// æ­¤æ—¶ a å’Œ b çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 2</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"a use_count: "</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// è¾“å‡ºï¼š2</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b use_count: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// è¾“å‡ºï¼š2</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<hr />

<p>å‚è€ƒèµ„æ–™ï¼š</p>

<p>1ã€è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼š<a href="https://cloud.tencent.com/developer/article/1784372">C++(STL):04â€”æ™ºèƒ½æŒ‡é’ˆä¹‹weak_ptr</a></p>
:ET